<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لوحة تحكم مركز الفارس للعناية بالرجل</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
    }

    /* Enhanced color scheme */
    :root {
      --primary-color: #2563eb;
      --primary-dark: #1e40af;
      --secondary-color: #06b6d4;
      --accent-color: #f59e0b;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --dark-color: #1f2937;
      --light-color: #f8fafc;
    }

    /* Enhanced login page */
    .login-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }

    .login-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    .login-card {
      backdrop-filter: blur(15px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 10;
    }

    .login-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      background: rgba(255, 255, 255, 0.98);
    }

    .login-input {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.9);
      position: relative;
    }

    .login-input:focus {
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      border-color: var(--primary-color);
    }

    .login-btn {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .login-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .login-btn:hover::before {
      left: 100%;
    }

    .login-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(37, 99, 235, 0.4);
    }

    .logo-animation {
      animation: logoFloat 3s ease-in-out infinite;
    }

    @keyframes logoFloat {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(2deg); }
    }

    /* Enhanced form inputs */
    .form-group {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .form-input-enhanced {
      width: 100%;
      padding: 1rem 3rem 1rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: rgba(248, 250, 252, 0.8);
    }

    .form-input-enhanced:focus {
      outline: none;
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      transform: translateY(-1px);
    }

    .form-icon {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
      transition: color 0.3s ease;
    }

    .form-input-enhanced:focus + .form-icon {
      color: var(--primary-color);
    }

    /* Enhanced dashboard cards */
    .dashboard-card {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .dashboard-card:hover::before {
      transform: scaleX(1);
    }

    .dashboard-card:hover {
      transform: translateY(-12px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      border-color: var(--primary-color);
    }

    /* Modern buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary-color) 0%, #0891b2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(6, 182, 212, 0.3);
    }

    /* Enhanced form styling */
    .form-input {
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
      background: #f8fafc;
    }

    .form-input:focus {
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      outline: none;
    }

    /* Enhanced tables */
    .modern-table {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .modern-table th {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      font-weight: 600;
      padding: 1rem;
    }

    .modern-table td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid #f1f5f9;
    }

    .modern-table tbody tr:hover {
      background: #f8fafc;
    }

    /* Page sections */
    .page-section {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
    }

    /* Status badges */
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .status-success {
      background: #dcfce7;
      color: #166534;
    }

    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Enhanced navigation */
    .nav-btn {
      position: relative;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .nav-btn:hover {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary-color);
    }

    .nav-btn:before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: 3px;
      background: var(--primary-color);
      border-radius: 0 3px 3px 0;
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .nav-btn:hover:before {
      transform: scaleY(1);
    }

    /* Enhanced payroll section */
    .payroll-card {
      background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 2px solid #0284c7;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .formula-display {
      background: #1e293b;
      color: #f1f5f9;
      padding: 1rem;
      border-radius: 0.75rem;
      font-family: 'Courier New', monospace;
      margin: 1rem 0;
    }

    /* Icon colors for dashboard cards */
    .icon-blue { color: #3b82f6; }
    .icon-green { color: #10b981; }
    .icon-red { color: #ef4444; }
    .icon-yellow { color: #f59e0b; }
    .icon-purple { color: #8b5cf6; }
    .icon-pink { color: #ec4899; }
    .icon-teal { color: #14b8a6; }
    .icon-indigo { color: #6366f1; }
    .icon-orange { color: #f97316; }
    .icon-emerald { color: #059669; }
    .icon-cyan { color: #06b6d4; }

    /* Loading and animation enhancements */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Multi-select dropdown styles */
    .multi-select-container {
      position: relative;
    }

    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 0.75rem 0.75rem;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .multi-select-option {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s ease;
    }

    .multi-select-option:hover {
      background: #f8fafc;
    }

    .multi-select-option.selected {
      background: #eff6ff;
      color: #1d4ed8;
      font-weight: 600;
    }

    .selected-services {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .service-tag {
      background: #dbeafe;
      color: #1e40af;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .service-tag .remove-btn {
      cursor: pointer;
      color: #ef4444;
      font-weight: bold;
    }

    .service-tag .remove-btn:hover {
      color: #dc2626;
    }

    /* Appointment notification styles */
    .appointment-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideInFromRight 0.5s ease-out;
      min-width: 350px;
      border: 2px solid #fbbf24;
    }

    .appointment-notification.urgent {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-color: #f87171;
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
    }

    .appointment-notification .notification-icon {
      font-size: 1.5rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes slideInFromRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .appointment-notification.fade-out {
      animation: fadeOut 0.5s ease-out forwards;
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .dashboard-card {
        padding: 1.5rem;
      }
      
      .page-section {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .login-card {
        margin: 1rem;
        padding: 2rem;
      }

      .appointment-notification {
        right: 10px;
        left: 10px;
        min-width: auto;
      }
    }

    /* Print styles */
    @media print {
      body * {
        visibility: hidden;
      }
      .printable-content,
      .printable-content * {
        visibility: visible;
      }
      .printable-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        font-size: 12px;
        font-family: "Cairo", sans-serif;
        direction: rtl;
        padding: 8px 10px;
        box-sizing: border-box;
        white-space: pre-wrap;
      }
      #printableReceipt, #printableReceipt * {
        visibility: visible;
      }
      #printableReceipt {
        position: absolute;
        left: 0;
        top: 0;
        width: 80mm;
        font-size: 12px;
        font-family: monospace, "Cairo", sans-serif;
        direction: rtl;
        padding: 8px;
        box-sizing: border-box;
      }
    }

    /* Error message enhancement */
    .error-message {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 1px solid #f87171;
      color: #dc2626;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-weight: 500;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* Success message enhancement */
    .success-message {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      border: 1px solid #4ade80;
      color: #16a34a;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-weight: 500;
    }

    /* WhatsApp notification styling */
    .whatsapp-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #25d366 0%, #20b358 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(37, 211, 102, 0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideInFromRight 0.5s ease-out;
      min-width: 300px;
    }

    .whatsapp-notification.fade-out {
      animation: fadeOut 0.5s ease-out forwards;
    }

    /* Monthly Income Report Styles */
    .income-card {
      background: linear-gradient(145deg, #f0fdf4 0%, #dcfce7 100%);
      border: 2px solid #16a34a;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .income-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .income-summary-card {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1px solid #e5e7eb;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .income-summary-card h4 {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .income-summary-card .amount {
      font-size: 1.5rem;
      font-weight: bold;
      color: #16a34a;
    }

    .month-selector {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-white to-slate-100 min-h-screen flex flex-col">

  <!-- Enhanced Login Page -->
  <section class="login-bg flex items-center justify-center p-6" id="login">
    <div class="login-card rounded-3xl shadow-2xl p-12 w-full max-w-md">
      <div class="flex justify-center mb-8">
        <div class="logo-animation">
          <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
            <i class="fas fa-cut text-white text-3xl"></i>
          </div>
        </div>
      </div>
      
      <h1 class="text-4xl font-bold text-center mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
        مركز الفارس
      </h1>
      
      <h2 class="text-2xl font-bold mb-8 text-gray-600 text-center">
        للعناية بالرجل
      </h2>
      
      <form class="space-y-6 w-full" id="form-login">
        <div class="form-group">
          <input
            class="form-input-enhanced"
            id="username"
            name="username"
            placeholder="اسم المستخدم"
            required
            type="text"
            autocomplete="username"
          />
          <i class="fas fa-user form-icon"></i>
        </div>
        
        <div class="form-group">
          <input
            class="form-input-enhanced"
            id="password"
            name="password"
            placeholder="كلمة المرور"
            required
            type="password"
            autocomplete="current-password"
          />
          <i class="fas fa-lock form-icon"></i>
          <button
            type="button"
            class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 transition"
            id="togglePassword"
          >
            <i class="fas fa-eye" id="eyeIcon"></i>
          </button>
        </div>
        
        <div class="flex items-center justify-between text-sm">
          <button
            type="button"
            class="text-blue-600 hover:text-blue-800 focus:outline-none transition flex items-center"
            id="forgotPasswordBtn"
          >
            <i class="fas fa-question-circle ml-1"></i>
            نسيت كلمة المرور؟
          </button>
          <button
            type="button"
            class="text-blue-600 hover:text-blue-800 focus:outline-none transition flex items-center"
            id="changePasswordBtn"
          >
            <i class="fas fa-key ml-1"></i>
            تغيير كلمة المرور
          </button>
        </div>
        
        <div>
          <button
            class="login-btn w-full text-white px-6 py-4 rounded-xl focus:outline-none font-bold text-xl shadow-lg flex items-center justify-center gap-3"
            type="submit"
          >
            <i class="fas fa-sign-in-alt"></i>
            تسجيل الدخول
          </button>
        </div>
        
        <div class="error-message text-center select-none hidden" id="loginError" role="alert">
        </div>
      </form>
      
      <div class="mt-8 text-center">
        <div class="text-blue-600 text-sm mb-2">
          <i class="fas fa-store ml-1"></i>
          مركز الفارس للعناية بالرجل
        </div>
        <div class="text-blue-500 text-xs">
          نظام إدارة متطور وآمن 
        </div>
      </div>
    </div>
  </section>

  <!-- Change Password Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="changePasswordModal">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6 mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-900">تغيير كلمة المرور</h3>
        <button
          id="closeChangePasswordModal"
          class="text-gray-500 hover:text-gray-700 focus:outline-none"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="changePasswordForm" class="space-y-4">
        <div>
          <label for="phoneInput" class="block mb-1 font-semibold text-gray-800">رقم الهاتف</label>
          <input
            type="tel"
            id="phoneInput"
            placeholder="أدخل رقم الهاتف"
            required
            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-4 focus:ring-blue-400 text-lg"
          />
        </div>
        
        <div>
          <label for="oldPasswordInput" class="block mb-1 font-semibold text-gray-800">كلمة المرور القديمة</label>
          <input
            type="password"
            id="oldPasswordInput"
            placeholder="أدخل كلمة المرور القديمة"
            required
            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-4 focus:ring-blue-400 text-lg"
          />
        </div>
        
        <div>
          <label for="newPasswordInput" class="block mb-1 font-semibold text-gray-800">كلمة المرور الجديدة</label>
          <input
            type="password"
            id="newPasswordInput"
            placeholder="أدخل كلمة المرور الجديدة"
            required
            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-4 focus:ring-blue-400 text-lg"
            minlength="6"
          />
        </div>
        
        <div class="flex justify-between items-center">
          <button
            type="button"
            id="cancelChangePasswordBtn"
            class="px-6 py-3 rounded-lg bg-gray-300 hover:bg-gray-400 transition font-semibold focus:outline-none"
          >
            إلغاء
          </button>
          <button
            type="submit"
            class="px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition font-semibold focus:outline-none flex items-center gap-2"
          >
            <i class="fas fa-key"></i>
            تغيير
          </button>
        </div>
        
        <div class="error-message text-center select-none hidden" id="changePasswordError" role="alert">
        </div>
        <div class="success-message text-center select-none hidden" id="changePasswordSuccess" role="alert">
        </div>
      </form>
    </div>
  </div>

  <!-- Main App Content -->
  <div class="hidden flex flex-col min-h-screen" id="appContent">
    <header class="bg-white shadow-lg p-4 flex items-center justify-between sticky top-0 z-30 border-b-2 border-blue-100">
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-wide flex items-center gap-3 select-none">
        <i class="fas fa-chart-line text-blue-600"></i>
        لوحة تحكم مركز الفارس
      </h1>
      
      <nav class="hidden lg:flex space-x-4 text-gray-700 font-semibold">
        <button class="nav-btn text-green-600" data-page="home">الرئيسية</button>
        <button class="nav-btn text-red-600" data-page="expenses">المصروفات</button>
        <button class="nav-btn text-brown" data-page="payrollManagement">حساب الراتب</button>
        <button class="nav-btn text-yellow-600" data-page="withdrawals">السحب</button>
        <button class="nav-btn text-green-600" data-page="appointments">المواعيد</button>
        <button class="nav-btn text-blue-600" data-page="services">الخدمات</button>
        <button class="nav-btn text-red-600" data-page="inventory">المخزون</button>
        <button class="nav-btn text-brown" data-page="reports">التقارير</button>
        <button class="nav-btn text-black" data-page="dailySalary">الراتب اليومي</button>
        <button class="nav-btn text-yellow-600" data-page="monthlySalary">الراتب الشهري</button>
        <button class="nav-btn text-green-600" data-page="posSection">نقاط البيع</button>
        <button class="nav-btn text-indigo-600" data-page="paymentSummary">ملخص الدفع</button>
        <button class="nav-btn text-red-600 flex items-center gap-2" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          خروج
        </button>
      </nav>
      
      <button class="lg:hidden text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 rounded p-2" id="mobileMenuBtn">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </header>
    
    <!-- Mobile menu -->
    <div class="fixed top-0 right-0 h-full w-72 bg-white shadow-lg transform translate-x-full transition-transform z-40 lg:hidden" id="mobileMenu">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-blue-600 to-purple-600">
        <h2 class="text-xl font-bold text-white select-none">القائمة</h2>
        <button class="text-white focus:outline-none focus:ring-2 focus:ring-white rounded" id="mobileMenuClose">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <nav class="flex flex-col p-4 space-y-2 text-gray-700 font-semibold max-h-screen overflow-y-auto">
        <button class="nav-btn text-right" data-page="home">الرئيسية</button>
        <button class="nav-btn text-right" data-page="expenses">المصروفات</button>
        <button class="nav-btn text-right" data-page="payrollManagement">حساب الراتب</button>
        <button class="nav-btn text-right" data-page="withdrawals">السحب</button>
        <button class="nav-btn text-right" data-page="appointments">المواعيد</button>
        <button class="nav-btn text-right" data-page="services">الخدمات</button>
        <button class="nav-btn text-right" data-page="inventory">المخزون</button>
        <button class="nav-btn text-right" data-page="reports">التقارير</button>
        <button class="nav-btn text-right" data-page="dailySalary">الراتب اليومي</button>
        <button class="nav-btn text-right" data-page="monthlySalary">الراتب الشهري</button>
        <button class="nav-btn text-right text-green-600" data-page="posSection">نقاط البيع</button>
        <button class="nav-btn text-right text-indigo-600" data-page="paymentSummary">ملخص الدفع</button>
        <button class="nav-btn text-right text-red-600 flex items-center gap-2 mt-4" id="mobileLogoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          تسجيل الخروج
        </button>
      </nav>
    </div>
    
    <main class="flex-grow container mx-auto p-6 max-w-7xl overflow-auto">
      <!-- الرئيسية -->
      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 fade-in" id="home">
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="expenses" role="button" tabindex="0">
          <i class="fas fa-wallet text-7xl icon-blue mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">المصروفات</h2>
          <p class="text-gray-600 text-center">إدارة وتتبع المصروفات المالية</p>
        </div>

        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="payrollManagement" role="button" tabindex="0">
          <i class="fas fa-calculator text-7xl icon-purple mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">حساب الراتب</h2>
          <p class="text-gray-600 text-center">حساب صافي الراتب بالمعادلة المتقدمة</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="withdrawals" role="button" tabindex="0">
          <i class="fas fa-hand-holding-usd text-7xl icon-red mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">السحب</h2>
          <p class="text-gray-600 text-center">إدارة عمليات السحب النقدي</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="appointments" role="button" tabindex="0">
          <i class="fas fa-calendar-alt text-7xl icon-yellow mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">المواعيد</h2>
          <p class="text-gray-600 text-center">جدولة وإدارة المواعيد</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="services" role="button" tabindex="0">
          <i class="fas fa-cut text-7xl icon-pink mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">الخدمات</h2>
          <p class="text-gray-600 text-center">قائمة الخدمات المقدمة</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="inventory" role="button" tabindex="0">
          <i class="fas fa-boxes text-7xl icon-teal mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">المخزون</h2>
          <p class="text-gray-600 text-center">إدارة المخزون والمنتجات</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="reports" role="button" tabindex="0">
          <i class="fas fa-chart-line text-7xl icon-indigo mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">التقارير</h2>
          <p class="text-gray-600 text-center">تقارير مفصلة عن الأداء</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="dailySalary" role="button" tabindex="0">
          <i class="fas fa-calendar-day text-7xl icon-orange mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">الراتب اليومي</h2>
          <p class="text-gray-600 text-center">حساب الرواتب اليومية</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="monthlySalary" role="button" tabindex="0">
          <i class="fas fa-calendar-check text-7xl icon-purple mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">الراتب الشهري</h2>
          <p class="text-gray-600 text-center">حساب الرواتب الشهرية</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="posSection" role="button" tabindex="0">
          <i class="fas fa-cash-register text-7xl icon-emerald mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">نقاط البيع</h2>
          <p class="text-gray-600 text-center">نظام إدارة المبيعات مع واتساب</p>
        </div>
        
        <div class="dashboard-card cursor-pointer rounded-xl shadow-lg p-6 flex flex-col items-center transition-all duration-300" data-page="paymentSummary" role="button" tabindex="0">
          <i class="fas fa-credit-card text-7xl icon-cyan mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-gray-800">ملخص الدفع</h2>
          <p class="text-gray-600 text-center">ملخص طرق الدفع</p>
        </div>
      </section>

      <!-- Payroll Management Page -->
      <section class="hidden fade-in" id="payrollManagement">
        <button class="btn-primary mb-6 flex items-center gap-2" id="backFromPayrollManagement">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-purple-600 inline-block pb-2">
            إدارة دفع الرواتب للموظفين
          </h2>

          <!-- Formula Display -->
          <div class="payroll-card">
            <h3 class="text-xl font-bold mb-4 text-blue-800">معادلة حساب صافي الراتب</h3>
            <div class="formula-display">
              صافي الراتب = (الراتب الشهري × النسبة%) + المبلغ الإضافي - السحب الشهري
            </div>
            <p class="text-sm text-gray-600 mt-2">
              * النسبة المئوية: نسبة من الراتب الأساسي (مثال: 100% = الراتب كاملاً، 50% = نصف الراتب)<br>
              * المبلغ الإضافي: أي مبالغ إضافية مثل البونص أو العلاوات<br>
              * السحب الشهري: إجمالي المبالغ المسحوبة خلال الشهر
            </p>
          </div>

          <!-- Payroll Form -->
          <form class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="payrollForm">
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="payrollWorker">
                <i class="fas fa-user ml-2 text-purple-600"></i>
                اسم الموظف
              </label>
              <input
                class="form-input w-full"
                id="payrollWorker"
                placeholder="أدخل اسم الموظف"
                required
                type="text"
              />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="payrollBaseSalary">
                <i class="fas fa-coins ml-2 text-green-600"></i>
                الراتب الشهري الأساسي (ريال)
              </label>
              <input
                class="form-input w-full"
                id="payrollBaseSalary"
                min="0"
                placeholder="أدخل الراتب الأساسي"
                required
                step="0.01"
                type="number"
              />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="payrollPercentage">
                <i class="fas fa-percentage ml-2 text-blue-600"></i>
                النسبة المئوية (%)
              </label>
              <input
                class="form-input w-full"
                id="payrollPercentage"
                min="0"
                max="200"
                placeholder="مثال: 100"
                required
                step="0.01"
                type="number"
                value="100"
              />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="payrollAdditionalAmount">
                <i class="fas fa-plus ml-2 text-emerald-600"></i>
                المبلغ الإضافي (ريال)
              </label>
              <input
                class="form-input w-full"
                id="payrollAdditionalAmount"
                min="0"
                placeholder="بونص، علاوة، إلخ..."
                step="0.01"
                type="number"
                value="0"
              />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="payrollMonth">
                <i class="fas fa-calendar ml-2 text-orange-600"></i>
                الشهر والسنة
              </label>
              <input
                class="form-input w-full"
                id="payrollMonth"
                required
                type="month"
              />
            </div>
            
            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
              <button
                class="btn-primary flex items-center gap-3 text-lg px-8 py-3"
                type="submit"
              >
                <i class="fas fa-calculator"></i>
                حساب وحفظ الراتب
              </button>
            </div>
          </form>

          <!-- Payroll Result Display -->
          <div class="payroll-card hidden" id="payrollResult">
            <h3 class="text-xl font-bold mb-4 text-green-800">نتيجة حساب الراتب</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="payrollResultContent">
              <!-- Results will be populated here -->
            </div>
          </div>
        </div>

        <!-- Payroll Records Table -->
        <div class="page-section">
          <h3 class="text-2xl font-bold mb-4 text-gray-900">سجل الرواتب المحسوبة</h3>
          <div class="overflow-x-auto">
            <table class="modern-table w-full">
              <thead>
                <tr>
                  <th>اسم الموظف</th>
                  <th>الراتب الأساسي</th>
                  <th>النسبة %</th>
                  <th>المبلغ الإضافي</th>
                  <th>السحب الشهري</th>
                  <th>صافي الراتب</th>
                  <th>الشهر</th>
                  <th>تاريخ الحساب</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="payrollTableBody">
                <!-- Table rows will be populated here -->
              </tbody>
            </table>
          </div>
          
          <div class="flex justify-end mt-4">
            <button id="deleteAllPayrollBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
              <i class="fas fa-trash-alt"></i>
              حذف جميع السجلات
            </button>
          </div>
        </div>
      </section>

      <!-- Expenses Page -->
      <section class="hidden fade-in" id="expenses">
        <button class="btn-primary mb-6 flex items-center gap-2" id="backFromExpenses">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-blue-600 inline-block pb-2">
            إدارة وتتبع المصروفات المالية
          </h2>
          
          <form class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6" id="expenseForm">
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="expenseDate">
                تاريخ المصروف
              </label>
              <input class="form-input w-full" id="expenseDate" required type="date" />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="expenseCategory">
                الفئة
              </label>
              <select class="form-input w-full" id="expenseCategory" required>
                <option disabled selected value="">اختر الفئة</option>
                <option value="إيجار">إيجار</option>
                <option value="مستلزمات">مستلزمات</option>
                <option value="فواتير">فواتير</option>
                <option value="أخرى">أخرى</option>
              </select>
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="expenseAmount">
                المبلغ (ريال)
              </label>
              <input
                class="form-input w-full"
                id="expenseAmount"
                min="0"
                placeholder="أدخل المبلغ"
                required
                step="0.01"
                type="number"
              />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="expenseDescription">
                الوصف
              </label>
              <input
                class="form-input w-full"
                id="expenseDescription"
                placeholder="وصف المصروف"
                type="text"
              />
            </div>
            
            <div class="md:col-span-4 flex justify-end">
              <button class="btn-primary flex items-center gap-3" type="submit">
                <i class="fas fa-plus"></i>
                إضافة مصروف
              </button>
            </div>
          </form>
        </div>
        
        <div class="page-section">
          <div class="overflow-x-auto">
            <table class="modern-table w-full">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>الفئة</th>
                  <th>المبلغ (ريال)</th>
                  <th>الوصف</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="expensesTableBody"></tbody>
            </table>
          </div>
          
          <div class="flex justify-end mt-4">
            <button id="deleteAllExpensesBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
              <i class="fas fa-trash-alt"></i>
              حذف الكل
            </button>
          </div>
        </div>
      </section>

      <!-- Withdrawals Page -->
      <section class="hidden fade-in" id="withdrawals">
        <button class="bg-red-600 text-white px-5 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromWithdrawals">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-red-600 inline-block pb-2">
            إدارة عمليات السحب النقدي وحساب السحب الشهري
          </h2>
          
          <form class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6" id="withdrawalForm">
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="withdrawalDate">
                تاريخ السحب
              </label>
              <input class="form-input w-full" id="withdrawalDate" required type="date" />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="withdrawalWorker">
                اسم العامل
              </label>
              <input
                class="form-input w-full"
                id="withdrawalWorker"
                placeholder="أدخل اسم العامل"
                required
                type="text"
              />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="withdrawalAmount">
                المبلغ (ريال)
              </label>
              <input
                class="form-input w-full"
                id="withdrawalAmount"
                min="0"
                placeholder="أدخل المبلغ"
                required
                step="0.01"
                type="number"
              />
            </div>
            
            <div class="flex items-center gap-4 col-span-2">
              <button class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3" type="submit">
                <i class="fas fa-plus"></i>
                إضافة سحب
              </button>
              <button
                class="bg-red-800 text-white px-6 py-3 rounded-lg hover:bg-red-900 transition focus:outline-none font-semibold flex items-center gap-3"
                id="calculateMonthlyWithdrawalsBtn"
                type="button"
              >
                <i class="fas fa-calculator"></i>
                حساب السحب الشهري
              </button>
            </div>
          </form>
        </div>
        
        <div class="page-section">
          <div class="overflow-x-auto">
            <table class="modern-table w-full">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>اسم العامل</th>
                  <th>المبلغ (ريال)</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="withdrawalsTableBody"></tbody>
            </table>
          </div>
          
          <div class="bg-red-50 border border-red-200 p-6 rounded-lg text-red-800 hidden mt-6" id="monthlyWithdrawalSummary">
            <h3 class="text-xl font-bold mb-4">ملخص السحب الشهري</h3>
            <div class="space-y-2 text-lg" id="monthlyWithdrawalContent"></div>
          </div>
          
          <div class="flex justify-end mt-4">
            <button id="deleteAllWithdrawalsBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
              <i class="fas fa-trash-alt"></i>
              حذف الكل
            </button>
          </div>
        </div>
      </section>

      <!-- Enhanced Appointments Page -->
      <section class="hidden fade-in" id="appointments">
        <button class="bg-yellow-600 text-white px-5 py-3 rounded-lg hover:bg-yellow-700 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromAppointments">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-yellow-600 inline-block pb-2">
            جدولة وإدارة المواعيد مع التنبيهات الذكية
          </h2>
          
          <form class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6" id="appointmentForm">
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="appointmentDate">
                <i class="fas fa-calendar ml-2 text-yellow-600"></i>
                تاريخ الموعد
              </label>
              <input class="form-input w-full" id="appointmentDate" required type="date" />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="appointmentTime">
                <i class="fas fa-clock ml-2 text-yellow-600"></i>
                وقت الموعد
              </label>
              <input class="form-input w-full" id="appointmentTime" required type="time" />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="appointmentCustomer">
                <i class="fas fa-user ml-2 text-yellow-600"></i>
                اسم العميل
              </label>
              <input
                class="form-input w-full"
                id="appointmentCustomer"
                placeholder="أدخل اسم العميل"
                required
                type="text"
              />
            </div>

            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="appointmentPhone">
                <i class="fas fa-phone ml-2 text-yellow-600"></i>
                رقم الهاتف
              </label>
              <input
                class="form-input w-full"
                id="appointmentPhone"
                placeholder="أدخل رقم الهاتف"
                required
                type="tel"
              />
            </div>

            <div class="md:col-span-2">
              <label class="block mb-2 font-semibold text-gray-800">
                <i class="fas fa-cut ml-2 text-yellow-600"></i>
                الخدمات المطلوبة
              </label>
              <div class="multi-select-container">
                <input
                  class="form-input w-full cursor-pointer"
                  id="servicesSelectInput"
                  placeholder="اختر الخدمات المطلوبة"
                  readonly
                  type="text"
                />
                <div class="multi-select-dropdown hidden" id="servicesDropdown">
                  <!-- Services options will be populated here -->
                </div>
              </div>
              <div class="selected-services" id="selectedServices">
                <!-- Selected services tags will appear here -->
              </div>
            </div>
            
            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
              <button class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition focus:outline-none font-semibold flex items-center gap-3" type="submit">
                <i class="fas fa-plus"></i>
                إضافة موعد
              </button>
            </div>
          </form>
        </div>
        
        <div class="page-section">
          <h3 class="text-xl font-bold mb-4 text-gray-900">جدول المواعيد</h3>
          <div class="overflow-x-auto">
            <table class="modern-table w-full">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>الوقت</th>
                  <th>اسم العميل</th>
                  <th>رقم الهاتف</th>
                  <th>الخدمات</th>
                  <th>الحالة</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="appointmentsTableBody"></tbody>
            </table>
          </div>
          
          <div class="flex justify-end mt-4">
            <button id="deleteAllAppointmentsBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
              <i class="fas fa-trash-alt"></i>
              حذف الكل
            </button>
          </div>
        </div>
      </section>

      <!-- Services Page -->
      <section class="hidden fade-in" id="services">
        <button class="bg-pink-600 text-white px-5 py-3 rounded-lg hover:bg-pink-700 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromServices">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-pink-600 inline-block pb-2">
            قائمة الخدمات المقدمة للعملاء
          </h2>
          
          <form class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" id="serviceForm">
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="serviceName">
                اسم الخدمة
              </label>
              <input
                class="form-input w-full"
                id="serviceName"
                placeholder="أدخل اسم الخدمة"
                required
                type="text"
              />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-gray-800" for="servicePriceInput">
                السعر (ريال)
              </label>
              <input
                class="form-input w-full"
                id="servicePriceInput"
                min="0"
                placeholder="أدخل السعر"
                required
                step="0.01"
                type="number"
              />
            </div>
            
            <div class="flex items-center gap-4">
              <button class="bg-pink-600 text-white px-6 py-3 rounded-lg hover:bg-pink-700 transition focus:outline-none font-semibold flex items-center gap-3" type="submit">
                <i class="fas fa-plus"></i>
                إضافة خدمة
              </button>
            </div>
          </form>
        </div>
        
        <div class="page-section">
          <div class="overflow-x-auto">
            <table class="modern-table w-full">
              <thead>
                <tr>
                  <th>اسم الخدمة</th>
                  <th>السعر (ريال)</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="servicesTableBody"></tbody>
            </table>
          </div>
          
          <div class="flex justify-end mt-4">
            <button id="deleteAllServicesBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
              <i class="fas fa-trash-alt"></i>
              حذف الكل
            </button>
          </div>
        </div>
      </section>

      <!-- Enhanced Inventory Page -->
      <section class="hidden fade-in" id="inventory">
        <button class="bg-teal-600 text-white px-5 py-3 rounded-lg hover:bg-teal-700 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromInventory">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-teal-600 inline-block pb-2">
            إدارة المخزون والمنتجات مع تتبع الحركة
          </h2>

          <!-- Add New Item Form -->
          <div class="bg-gradient-to-r from-teal-50 to-blue-50 rounded-lg shadow p-6 mb-6 border border-teal-200">
            <h3 class="text-xl font-bold mb-4 text-teal-700">إضافة منتج جديد</h3>
            <form class="grid grid-cols-1 md:grid-cols-4 gap-6" id="inventoryForm">
              <div>
                <label class="block mb-2 font-semibold text-gray-800" for="productName">
                  اسم المنتج
                </label>
                <input
                  class="form-input w-full"
                  id="productName"
                  placeholder="أدخل اسم المنتج"
                  required
                  type="text"
                />
              </div>
              
              <div>
                <label class="block mb-2 font-semibold text-gray-800" for="productQuantity">
                  الكمية الأولية
                </label>
                <input
                  class="form-input w-full"
                  id="productQuantity"
                  min="0"
                  placeholder="أدخل الكمية"
                  required
                  step="1"
                  type="number"
                />
              </div>
              
              <div>
                <label class="block mb-2 font-semibold text-gray-800" for="productPrice">
                  السعر (ريال)
                </label>
                <input
                  class="form-input w-full"
                  id="productPrice"
                  min="0"
                  placeholder="أدخل السعر"
                  required
                  step="0.01"
                  type="number"
                />
              </div>
              
              <div class="flex items-center gap-4">
                <button class="bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition focus:outline-none font-semibold flex items-center gap-3" type="submit">
                  <i class="fas fa-plus"></i>
                  إضافة منتج
                </button>
              </div>
            </form>
          </div>

          <!-- Stock Movement Form -->
          <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg shadow p-6 mb-6 border border-orange-200">
            <h3 class="text-xl font-bold mb-4 text-orange-700">حركة المخزون</h3>
            <form class="grid grid-cols-1 md:grid-cols-5 gap-6" id="stockMovementForm">
              <div>
                <label class="block mb-2 font-semibold text-gray-800" for="movementProduct">
                  اختر المنتج
                </label>
                <select class="form-input w-full" id="movementProduct" required>
                  <option disabled selected value="">اختر المنتج</option>
                </select>
              </div>
              
              <div>
                <label class="block mb-2 font-semibold text-gray-800" for="movementType">
                  نوع الحركة
                </label>
                <select class="form-input w-full" id="movementType" required>
                  <option disabled selected value="">اختر نوع الحركة</option>
                  <option value="add">إضافة مخزون</option>
                  <option value="withdraw">سحب من المخزون</option>
                </select>
              </div>
              
              <div>
                <label class="block mb-2 font-semibold text-gray-800" for="movementQuantity">
                  الكمية
                </label>
                <input
                  class="form-input w-full"
                  id="movementQuantity"
                  min="1"
                  placeholder="أدخل الكمية"
                  required
                  step="1"
                  type="number"
                />
              </div>
              
              <div>
                <label class="block mb-2 font-semibold text-gray-800" for="movementNote">
                  ملاحظة
                </label>
                <input
                  class="form-input w-full"
                  id="movementNote"
                  placeholder="ملاحظة اختيارية"
                  type="text"
                />
              </div>
              
              <div class="flex items-center gap-4">
                <button class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition focus:outline-none font-semibold flex items-center gap-3" type="submit">
                  <i class="fas fa-exchange-alt"></i>
                  تنفيذ الحركة
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Inventory Table -->
        <div class="page-section">
          <h3 class="text-xl font-bold mb-4 text-teal-600">المخزون الحالي</h3>
          <div class="overflow-x-auto">
            <table class="modern-table w-full">
              <thead>
                <tr>
                  <th>اسم المنتج</th>
                  <th>إجمالي المضاف</th>
                  <th>إجمالي المسحوب</th>
                  <th>الرصيد الحالي</th>
                  <th>السعر (ريال)</th>
                  <th>حالة المخزون</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Stock Movement History -->
        <div class="page-section">
          <h3 class="text-xl font-bold mb-4 text-gray-600">سجل حركة المخزون</h3>
          <div class="overflow-x-auto">
            <table class="modern-table w-full">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>المنتج</th>
                  <th>نوع الحركة</th>
                  <th>الكمية</th>
                  <th>الملاحظة</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="stockMovementTableBody"></tbody>
            </table>
          </div>
          
          <div class="flex justify-end mt-4 gap-4">
            <button id="deleteAllMovementsBtn" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition focus:outline-none font-semibold flex items-center gap-3">
              <i class="fas fa-history"></i>
              حذف سجل الحركة
            </button>
            <button id="deleteAllInventoryBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
              <i class="fas fa-trash-alt"></i>
              حذف الكل
            </button>
          </div>
        </div>
      </section>

      <!-- Reports Page -->
      <section class="hidden fade-in" id="reports">
        <button class="bg-indigo-600 text-white px-5 py-3 rounded-lg hover:bg-indigo-700 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromReports">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold text-gray-900 border-b-4 border-indigo-600 inline-block pb-2">
            عرض تقارير مفصلة عن الأداء
          </h2>
          <button
            id="printAllReportsBtn"
            class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition focus:outline-none font-semibold flex items-center gap-3"
          >
            <i class="fas fa-print"></i>
            طباعة جميع التقارير
          </button>
        </div>
        
        <div class="space-y-6">
          <!-- Monthly Income Report -->
          <div class="page-section">
            <h3 class="text-xl font-bold mb-4 text-gray-900 flex items-center gap-2">
              <i class="fas fa-chart-line text-green-600"></i>
              تقرير الدخل الشهري
            </h3>
            
            <!-- Month Selector -->
            <div class="month-selector">
              <div class="flex flex-col md:flex-row gap-4 items-center">
                <label for="incomeReportMonth" class="font-semibold text-gray-800">اختر الشهر:</label>
                <input
                  type="month"
                  id="incomeReportMonth"
                  class="form-input"
                  style="max-width: 200px;"
                />
                <button
                  id="generateIncomeReportBtn"
                  class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition focus:outline-none font-semibold flex items-center gap-2"
                >
                  <i class="fas fa-chart-bar"></i>
                  إنشاء التقرير
                </button>
              </div>
            </div>

            <!-- Income Summary Cards -->
            <div class="income-card">
              <h4 class="text-lg font-bold mb-4 text-green-800">ملخص الدخل الشهري</h4>
              <div class="income-summary-grid">
                <div class="income-summary-card">
                  <h4>إجمالي المبيعات</h4>
                  <div class="amount" id="monthlyTotalSales">0.00 ريال</div>
                </div>
                <div class="income-summary-card">
                  <h4>مبيعات كاش</h4>
                  <div class="amount" id="monthlyCashSales">0.00 ريال</div>
                </div>
                <div class="income-summary-card">
                  <h4>مبيعات فيزا</h4>
                  <div class="amount" id="monthlyVisaSales">0.00 ريال</div>
                </div>
                <div class="income-summary-card">
                  <h4>عدد الفواتير</h4>
                  <div class="amount" id="monthlyInvoicesCount">0</div>
                </div>
              </div>
            </div>

            <!-- Monthly Income by Worker -->
            <div class="overflow-x-auto">
              <table class="modern-table w-full">
                <thead>
                  <tr>
                    <th>اسم العامل</th>
                    <th>عدد الفواتير</th>
                    <th>إجمالي المبيعات (ريال)</th>
                    <th>مبيعات كاش (ريال)</th>
                    <th>مبيعات فيزا (ريال)</th>
                  </tr>
                </thead>
                <tbody id="monthlyIncomeByWorkerBody">
                  <tr>
                    <td colspan="5" class="text-center py-4 text-gray-500">
                      يرجى اختيار شهر لعرض التقرير
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Daily Income Breakdown -->
            <div class="mt-6">
              <h4 class="text-lg font-bold mb-4 text-gray-900">تفصيل الدخل اليومي</h4>
              <div class="overflow-x-auto">
                <table class="modern-table w-full">
                  <thead>
                    <tr>
                      <th>التاريخ</th>
                      <th>عدد الفواتير</th>
                      <th>إجمالي المبيعات (ريال)</th>
                      <th>مبيعات كاش (ريال)</th>
                      <th>مبيعات فيزا (ريال)</th>
                    </tr>
                  </thead>
                  <tbody id="dailyIncomeBreakdownBody">
                    <tr>
                      <td colspan="5" class="text-center py-4 text-gray-500">
                        يرجى اختيار شهر لعرض التقرير
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Expenses Report -->
          <div class="page-section">
            <h3 class="text-xl font-bold mb-4 text-gray-900">تقرير المصروفات</h3>
            <p class="text-gray-700 mb-4">إجمالي المصروفات: <span class="font-bold text-blue-600" id="totalExpenses">0.00</span> ريال</p>
            <div class="overflow-x-auto">
              <table class="modern-table w-full">
                <thead>
                  <tr>
                    <th>الفئة</th>
                    <th>المبلغ (ريال)</th>
                  </tr>
                </thead>
                <tbody id="expenseReportBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Payroll Calculations Report -->
          <div class="page-section">
            <h3 class="text-xl font-bold mb-4 text-gray-900">تقرير حساب الراتب</h3>
            <p class="text-gray-700 mb-4">عرض سجلات حساب الرواتب المحسوبة باستخدام المعادلة المتقدمة</p>
            <div class="overflow-x-auto">
              <table class="modern-table w-full">
                <thead>
                  <tr>
                    <th>اسم الموظف</th>
                    <th>الراتب الأساسي</th>
                    <th>النسبة %</th>
                    <th>المبلغ الإضافي</th>
                    <th>السحب الشهري</th>
                    <th>صافي الراتب</th>
                    <th>الشهر</th>
                    <th>تاريخ الحساب</th>
                  </tr>
                </thead>
                <tbody id="payrollReportBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Withdrawals Report -->
          <div class="page-section">
            <h3 class="text-xl font-bold mb-4 text-gray-900">تقرير السحب</h3>
            <p class="text-gray-700 mb-4">إجمالي السحب: <span class="font-bold text-red-600" id="totalWithdrawals">0.00</span> ريال</p>
            <div class="overflow-x-auto">
              <table class="modern-table w-full">
                <thead>
                  <tr>
                    <th>اسم العامل</th>
                    <th>الشهر</th>
                    <th>المبلغ (ريال)</th>
                  </tr>
                </thead>
                <tbody id="withdrawalReportBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Invoices Report -->
          <div class="page-section">
            <h3 class="text-xl font-bold mb-4 text-gray-900">تقرير الفواتير</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <p class="text-sm text-blue-600 font-semibold">عدد الفواتير</p>
                <p class="text-2xl font-bold text-blue-800" id="totalInvoicesCount">0</p>
              </div>
              <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <p class="text-sm text-green-600 font-semibold">إجمالي المبيعات</p>
                <p class="text-2xl font-bold text-green-800" id="totalInvoicesAmount">0.00 ريال</p>
              </div>
              <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <p class="text-sm text-yellow-600 font-semibold">مبيعات كاش</p>
                <p class="text-2xl font-bold text-yellow-800" id="totalCashInvoices">0.00 ريال</p>
              </div>
              <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <p class="text-sm text-purple-600 font-semibold">مبيعات فيزا</p>
                <p class="text-2xl font-bold text-purple-800" id="totalVisaInvoices">0.00 ريال</p>
              </div>
            </div>
            
            <h4 class="text-lg font-bold mb-2 text-gray-900">مبيعات حسب العامل</h4>
            <div class="overflow-x-auto">
              <table class="modern-table w-full">
                <thead>
                  <tr>
                    <th>اسم العامل</th>
                    <th>إجمالي المبيعات (ريال)</th>
                  </tr>
                </thead>
                <tbody id="invoiceWorkerReportBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Daily Salary Page -->
      <section class="hidden fade-in" id="dailySalary">
        <button class="bg-orange-600 text-white px-5 py-3 rounded-lg hover:bg-orange-700 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromDailySalary">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-orange-600 inline-block pb-2">
            حساب الراتب اليومي للعمال بناءً على الفواتير المسجلة
          </h2>
          
          <form class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" id="dailySalaryForm">
            <div>
              <label for="dailyWorkerSelect" class="block mb-2 font-semibold text-gray-800">اسم العامل</label>
              <input
                class="form-input w-full"
                id="dailyWorkerSelect"
                placeholder="أدخل اسم العامل"
                required
                type="text"
              />
            </div>
            
            <div>
              <label for="dailyDateInput" class="block mb-2 font-semibold text-gray-800">التاريخ</label>
              <input type="date" id="dailyDateInput" class="form-input w-full" required />
            </div>
            
            <div class="md:col-span-3 flex justify-end">
              <button type="submit" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition focus:outline-none font-semibold flex items-center gap-3">
                <i class="fas fa-calculator"></i>
                حساب الراتب اليومي
              </button>
            </div>
          </form>
        </div>
        
        <div class="page-section bg-orange-50 border border-orange-200" id="dailySalaryResult">
          <h3 class="text-xl font-bold mb-4 text-orange-800">نتيجة حساب الراتب اليومي</h3>
          <p id="dailySalaryText" class="text-lg whitespace-pre-line text-orange-900"></p>
        </div>
        
        <div class="flex justify-end mt-4">
          <button id="deleteAllDailySalaryBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
            <i class="fas fa-trash-alt"></i>
            حذف الكل
          </button>
        </div>
      </section>

      <!-- Monthly Salary Page -->
      <section class="hidden fade-in" id="monthlySalary">
        <button class="bg-purple-600 text-white px-5 py-3 rounded-lg hover:bg-purple-700 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromMonthlySalary">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-purple-600 inline-block pb-2">
            حساب الراتب الشهري للعمال
          </h2>
          
          <form class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" id="monthlySalaryForm">
            <div>
              <label for="monthlyWorkerSelect" class="block mb-2 font-semibold text-gray-800">اسم العامل</label>
              <input
                class="form-input w-full"
                id="monthlyWorkerSelect"
                placeholder="أدخل اسم العامل"
                required
                type="text"
              />
            </div>
            
            <div>
              <label for="monthlyYearInput" class="block mb-2 font-semibold text-gray-800">السنة</label>
              <input type="number" id="monthlyYearInput" class="form-input w-full" min="2000" max="2100" placeholder="مثال: 2024" required />
            </div>
            
            <div>
              <label for="monthlyMonthInput" class="block mb-2 font-semibold text-gray-800">الشهر</label>
              <select id="monthlyMonthInput" class="form-input w-full" required>
                <option disabled selected value="">اختر الشهر</option>
                <option value="01">يناير</option>
                <option value="02">فبراير</option>
                <option value="03">مارس</option>
                <option value="04">أبريل</option>
                <option value="05">مايو</option>
                <option value="06">يونيو</option>
                <option value="07">يوليو</option>
                <option value="08">أغسطس</option>
                <option value="09">سبتمبر</option>
                <option value="10">أكتوبر</option>
                <option value="11">نوفمبر</option>
                <option value="12">ديسمبر</option>
              </select>
            </div>
            
            <div class="md:col-span-3 flex justify-end">
              <button type="submit" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition focus:outline-none font-semibold flex items-center gap-3">
                <i class="fas fa-calculator"></i>
                حساب الراتب الشهري
              </button>
            </div>
          </form>
        </div>
        
        <div class="page-section bg-purple-50 border border-purple-200 hidden" id="monthlySalaryResult">
          <h3 class="text-xl font-bold mb-4 text-purple-800">نتيجة حساب الراتب الشهري</h3>
          <p id="monthlySalaryText" class="text-lg whitespace-pre-line text-purple-900"></p>
        </div>
        
        <div class="flex justify-end mt-4">
          <button id="deleteAllMonthlySalaryBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
            <i class="fas fa-trash-alt"></i>
            حذف الكل
          </button>
        </div>
      </section>

      <!-- POS Section -->
      <section class="hidden fade-in" id="posSection">
        <button class="bg-emerald-700 text-white px-5 py-3 rounded-lg hover:bg-emerald-800 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromPOSBtn">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-4 flex flex-col lg:flex-row gap-4">
          <!-- Left side: product grid -->
          <div class="w-full lg:w-1/3 bg-gray-50 rounded-lg p-3 flex flex-col">
            <!-- Search input -->
            <input
              class="mb-3 rounded border border-gray-300 p-2 text-sm text-right placeholder-gray-400"
              id="searchInput"
              placeholder="بحث عن خدمة أو منتج..."
              type="text"
            />
            <!-- Product grid -->
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-2 overflow-y-auto max-h-96" id="productGrid"></div>
            <button
              class="mt-auto bg-blue-600 text-white text-sm rounded py-2 px-3 w-full hover:bg-blue-700 transition"
              id="showMoreBtn"
            >
              عرض المزيد
            </button>
          </div>
          
          <!-- Right side: main content -->
          <div class="w-full lg:w-2/3 bg-white rounded-lg p-4 flex flex-col">
            <!-- Top bar -->
            <div class="flex flex-col lg:flex-row justify-between items-center mb-3 text-sm text-gray-600 gap-2">
              <div class="font-semibold">فاتورة رقم 000000000000</div>
              <div class="flex gap-2 flex-wrap w-full lg:w-auto justify-center lg:justify-start">
                <input
                  class="form-input text-sm w-full lg:w-40"
                  id="workerName"
                  placeholder="اسم العامل"
                  type="text"
                />
                <input
                  class="form-input text-sm w-full lg:w-40"
                  id="customerName"
                  placeholder="اسم العميل"
                  type="text"
                />
              </div>
            </div>
            
            <!-- Payment method selection -->
            <div class="mb-3 flex gap-4 items-center text-sm text-gray-700">
              <label for="paymentMethod" class="font-semibold">طريقة الدفع:</label>
              <select id="paymentMethod" class="form-input text-sm">
                <option value="cash" selected>كاش</option>
                <option value="visa">فيزا</option>
              </select>
            </div>
            
            <!-- Table header -->
            <div class="grid grid-cols-6 gap-2 text-sm font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-2">
              <div>المنتج</div>
              <div>الكمية</div>
              <div>السعر</div>
              <div>الخصم</div>
              <div>الإجمالي</div>
              <div></div>
            </div>
            
            <!-- Table rows container -->
            <div class="flex flex-col gap-1 max-h-64 overflow-y-auto" id="invoiceItems"></div>
            
            <!-- Add product input -->
            <div class="flex items-center gap-2 mt-3 text-sm">
              <input
                class="flex-grow form-input text-sm"
                id="addProductInput"
                placeholder="أضف منتج أو خدمة"
                type="text"
              />
              <input
                class="w-24 form-input text-sm"
                id="manualPriceInput"
                placeholder="السعر"
                type="number"
                min="0"
                step="0.01"
              />
              <button
                class="bg-blue-600 text-white rounded px-4 py-2 text-sm hover:bg-blue-700 transition"
                id="addProductByNameBtn"
              >
                إضافة
              </button>
            </div>
            
            <!-- Bottom summary and buttons -->
            <div class="mt-auto flex flex-wrap gap-2 justify-between items-center pt-3 border-t border-gray-300 text-sm">
              <div class="text-green-600 font-bold text-lg" id="totalAmount">المجموع: 0.00 ريال</div>
              <div class="flex gap-2 flex-wrap">
                <button
                  class="bg-red-600 text-white rounded px-4 py-2 hover:bg-red-700 transition"
                  id="clearInvoiceBtn"
                >
                  إلغاء
                </button>
                <button
                  class="bg-green-600 text-white rounded px-4 py-2 hover:bg-green-700 transition flex items-center gap-2"
                  id="completeSaleBtn"
                >
                  <i class="fab fa-whatsapp"></i>
                  إتمام البيع
                </button>
                <button
                  class="bg-gray-600 text-white rounded px-4 py-2 hover:bg-gray-700 transition"
                  id="showInvoiceLogBtn"
                >
                  سجل الفواتير
                </button>
              </div>
            </div>
            
            <!-- Invoice Log Section -->
            <div class="mt-4 overflow-auto max-h-64 rounded-lg border border-gray-300 bg-gray-50 shadow p-2 hidden" id="invoiceLogSection">
              <h3 class="text-sm font-semibold text-gray-800 mb-2">سجل الفواتير</h3>
              <div class="overflow-x-auto">
                <table class="modern-table w-full">
                  <thead>
                    <tr>
                      <th>رقم الفاتورة</th>
                      <th>التاريخ</th>
                      <th>العامل</th>
                      <th>العميل</th>
                      <th>عدد العناصر</th>
                      <th>المجموع (ريال)</th>
                      <th>طريقة الدفع</th>
                      <th>إجراء</th>
                    </tr>
                  </thead>
                  <tbody id="invoiceLogTableBody"></tbody>
                </table>
              </div>
              <button class="mt-2 bg-red-600 text-white rounded px-3 py-1 text-xs hover:bg-red-700 transition focus:outline-none" id="closeInvoiceLogBtn">
                إغلاق السجل
              </button>
            </div>
            
            <div class="flex justify-end mt-4">
              <button id="deleteAllInvoicesBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition focus:outline-none font-semibold flex items-center gap-3">
                <i class="fas fa-trash-alt"></i>
                حذف الكل
              </button>
            </div>
          </div>
        </div>
        
        <!-- Hidden printable receipt container -->
        <div id="printableReceipt" class="hidden p-2 bg-white shadow-md rounded" style="white-space: pre-line;"></div>
      </section>

      <!-- Payment Summary Page -->
      <section class="hidden fade-in" id="paymentSummary">
        <button class="bg-cyan-600 text-white px-5 py-3 rounded-lg hover:bg-cyan-700 transition focus:outline-none flex items-center gap-2 mb-6" id="backFromPaymentSummary">
          <i class="fas fa-arrow-right"></i>
          العودة للرئيسية
        </button>
        
        <div class="page-section">
          <h2 class="text-3xl font-bold mb-6 text-gray-900 border-b-4 border-cyan-600 inline-block pb-2">
            ملخص طرق الدفع
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-6">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold text-green-800">المدفوع كاش</h3>
                  <p class="text-3xl font-bold text-green-600" id="totalCashAmount">0.00 ريال</p>
                </div>
                <i class="fas fa-money-bill-wave text-4xl text-green-500"></i>
              </div>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold text-blue-800">المدفوع فيزا</h3>
                  <p class="text-3xl font-bold text-blue-600" id="totalVisaAmount">0.00 ريال</p>
                </div>
                <i class="fas fa-credit-card text-4xl text-blue-500"></i>
              </div>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="modern-table w-full">
              <thead>
                <tr>
                  <th>طريقة الدفع</th>
                  <th>المبلغ الإجمالي (ريال)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="flex items-center gap-2">
                    <i class="fas fa-money-bill-wave text-green-600"></i>
                    كاش
                  </td>
                  <td class="font-bold text-green-600" id="totalCashAmountTable">0.00</td>
                </tr>
                <tr>
                  <td class="flex items-center gap-2">
                    <i class="fas fa-credit-card text-blue-600"></i>
                    فيزا
                  </td>
                  <td class="font-bold text-blue-600" id="totalVisaAmountTable">0.00</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
    
    <footer class="bg-white shadow-inner p-4 text-center text-gray-600 text-sm border-t border-gray-200">
      <div class="flex flex-col md:flex-row justify-between items-center gap-2">
        <div class="flex items-center gap-2">
          <i class="fas fa-copyright text-blue-600"></i>
          <span>2025 جميع الحقوق محفوظة | مركز الفارس للعناية بالرجل</span>
        </div>
        <div class="flex items-center gap-2 text-blue-600">
          <i class="fas fa-code"></i>
          <span>تصميم وتطوير بواسطة Eng-A7med-ra</span>
        </div>
        <div class="flex items-center gap-2 text-blue-600">
          <i class="fas fa-phone"></i>
          <span> Eng-A7med-ra-01091889366</span>
        </div>
      </div>
    </footer>
  </div>

  <!-- WhatsApp and Appointment Notification Container -->
  <div id="whatsappNotifications"></div>
  <div id="appointmentNotifications"></div>

  <script>
    // Global variables
    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    let payrollRecords = JSON.parse(localStorage.getItem('payrollRecords')) || [];
    let withdrawals = JSON.parse(localStorage.getItem('withdrawals')) || [];
    let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
    let servicesData = JSON.parse(localStorage.getItem('services')) || [];
    let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
    let stockMovements = JSON.parse(localStorage.getItem('stockMovements')) || [];
    let printedInvoices = JSON.parse(localStorage.getItem('salon_printed_invoices')) || [];

    // Enhanced appointments variables
    let selectedServices = [];
    let appointmentNotificationInterval;

    // WhatsApp phone number
    const WHATSAPP_PHONE = '+201091889366';

    // Products data for POS
    const allProducts = [
      { name: "حلاقة شعر + ذقن", price: 35, iconClass: "fas fa-cut", alt: "أيقونة حلاقة شعر وذقن", img: "https://placehold.co/60x60/png?text=حلاقة+شعر+وذقن" },
      { name: "حلاقة شعر نحته", price: 25, iconClass: "fas fa-cut", alt: "أيقونة حلاقة شعر نحته", img: "https://placehold.co/60x60/png?text=حلاقة+شعر+نحته" },
      { name: "حلاقة ذقن تحديد", price: 20, iconClass: "fas fa-beard", alt: "أيقونة حلاقة ذقن تحديد", img: "https://placehold.co/60x60/png?text=حلاقة+ذقن+تحديد" },
      { name: "حلاقة ذقن سكسوكه", price: 20, iconClass: "fas fa-beard", alt: "أيقونة حلاقة ذقن سكسوكه", img: "https://placehold.co/60x60/png?text=حلاقة+ذقن+سكسوكه" },
      { name: "حلاقة ذقن موس كامل", price: 15, iconClass: "fas fa-beard", alt: "أيقونة حلاقة ذقن موس كامل", img: "https://placehold.co/60x60/png?text=حلاقة+ذقن+موس+كامل" },
      { name: "حلاقة ذقن شعر طفل عادية", price: 20, iconClass: "fas fa-child", alt: "أيقونة حلاقة ذقن شعر طفل عادية", img: "https://placehold.co/60x60/png?text=حلاقة+ذقن+شعر+طفل" },
      { name: "استشوار", price: 20, iconClass: "fas fa-wind", alt: "أيقونة استشوار", img: "https://placehold.co/60x60/png?text=استشوار" },
      { name: "شمع", price: 25, iconClass: "fas fa-fire", alt: "أيقونة شمع", img: "https://placehold.co/60x60/png?text=شمع" },
      { name: "سنفرة عادية", price: 20, iconClass: "fas fa-hand-paper", alt: "أيقونة سنفرة عادية", img: "https://placehold.co/60x60/png?text=سنفرة+عادية" },
      { name: "قناع طين VIB", price: 50, iconClass: "fas fa-mask", alt: "أيقونة قناع طين VIB", img: "https://placehold.co/60x60/png?text=قناع+طين+VIB" },
      { name: "سنفرة مع فوطة حارة", price: 25, iconClass: "fas fa-hand-paper", alt: "أيقونة سنفرة مع فوطة حارة", img: "https://placehold.co/60x60/png?text=سنفرة+مع+فوطة+حارة" },
      { name: "سنفرة مع بخار", price: 30, iconClass: "fas fa-water", alt: "أيقونة سنفرة مع بخار", img: "https://placehold.co/60x60/png?text=سنفرة+مع+بخار" },
      { name: "نص تنظيف", price: 80, iconClass: "fas fa-broom", alt: "أيقونة نصف تنظيف", img: "https://placehold.co/60x60/png?text=نص+تنظيف" },
      { name: "صبغة بيجن", price: 40, iconClass: "fas fa-paint-brush", alt: "أيقونة صبغة بيجن", img: "https://placehold.co/60x60/png?text=صبغة+بيجن" },
      { name: "صبغة شامبو", price: 45, iconClass: "fas fa-paint-brush", alt: "أيقونة صبغة شامبو", img: "https://placehold.co/60x60/png?text=صبغة+شامبو" },
      { name: "صبغة ذقن", price: 30, iconClass: "fas fa-beard", alt: "أيقونة صبغة ذقن", img: "https://placehold.co/60x60/png?text=صبغة+ذقن" },
      { name: "قناع نعناع", price: 25, iconClass: "fas fa-leaf", alt: "أيقونة قناع نعناع", img: "https://placehold.co/60x60/png?text=قناع+نعناع" },
      { name: "قناع فلبيني", price: 50, iconClass: "fas fa-mask", alt: "أيقونة قناع فلبيني", img: "https://placehold.co/60x60/png?text=قناع+فلبيني" },
      { name: "معالج للقشرة", price: 120, iconClass: "fas fa-bug", alt: "أيقونة معالج للقشرة", img: "https://placehold.co/60x60/png?text=معالج+للقشرة" },
      { name: "معالج للشعر", price: 120, iconClass: "fas fa-spa", alt: "أيقونة معالج للشعر", img: "https://placehold.co/60x60/png?text=معالج+للشعر" },
      { name: "تنظيف كامل ليزر مع شفط دهون", price: 150, iconClass: "fas fa-laser", alt: "أيقونة تنظيف كامل ليزر مع شفط دهون", img: "https://placehold.co/60x60/png?text=تنظيف+ليزر+وشفط" },
      { name: "حمام مغربي", price: 150, iconClass: "fas fa-water", alt: "أيقونة حمام مغربي", img: "https://placehold.co/60x60/png?text=حمام+مغربي" },
      { name: "بروتين للشعر", price: 250, iconClass: "fas fa-flask", alt: "أيقونة بروتين للشعر", img: "https://placehold.co/60x60/png?text=بروتين+للشعر" },
      { name: "حمام زيت مع الجهاز", price: 40, iconClass: "fas fa-oil-can", alt: "أيقونة حمام زيت مع الجهاز", img: "https://placehold.co/60x60/png?text=حمام+زيت+مع+الجهاز" },
      { name: "حمام زيت عادي", price: 25, iconClass: "fas fa-oil-can", alt: "أيقونة حمام زيت عادي", img: "https://placehold.co/60x60/png?text=حمام+زيت+عادي" }
    ];

    // POS variables
    let invoiceItems = [];
    let showAll = false;

    // Authentication variables - MODIFIED FOR SEPARATE DELETE PASSWORD
    let validUser = JSON.parse(localStorage.getItem('validUser')) || {
      username: 'alfaris',
      password: '123456',
    };
    const phoneNumber = '01091889366';
    const DELETE_PASSWORD = '666666'; // Separate delete password

    // DOM Elements
    const loginSection = document.getElementById('login');
    const appContent = document.getElementById('appContent');
    const formLogin = document.getElementById('form-login');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');

    // Pages array
    const pages = [
      'home', 'expenses', 'payrollManagement', 'withdrawals', 'appointments', 
      'services', 'inventory', 'reports', 'dailySalary', 'monthlySalary', 
      'posSection', 'paymentSummary'
    ];

    // Enhanced Appointments Functions
    function showAppointmentNotification(message, type = 'warning', isUrgent = false) {
      const container = document.getElementById('appointmentNotifications');
      const notification = document.createElement('div');
      notification.className = `appointment-notification ${isUrgent ? 'urgent' : ''}`;
      
      const icon = isUrgent ? 'fa-exclamation-triangle' : 'fa-clock';
      notification.innerHTML = `
        <i class="fas ${icon} notification-icon"></i>
        <div>
          <div class="font-semibold">${isUrgent ? 'تنبيه عاجل!' : 'تذكير موعد'}</div>
          <div class="text-sm">${message}</div>
        </div>
        <button class="text-white hover:text-gray-200 focus:outline-none ml-2" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      container.appendChild(notification);
      
      // Auto-remove after appropriate time
      const timeout = isUrgent ? 10000 : 7000;
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
          if (container.contains(notification)) {
            container.removeChild(notification);
          }
        }, 500);
      }, timeout);
    }

    function checkUpcomingAppointments() {
      const now = new Date();
      const nowTime = now.getTime();

      appointments.forEach(appointment => {
        const appointmentDateTime = new Date(`${appointment.date}T${appointment.time}`);
        const appointmentTime = appointmentDateTime.getTime();
        const timeDiff = appointmentTime - nowTime;
        const minutesDiff = Math.floor(timeDiff / (1000 * 60));

        // Show notification for appointments in next 30 minutes
        if (minutesDiff > 0 && minutesDiff <= 30) {
          const message = `موعد ${appointment.customer} خلال ${minutesDiff} دقيقة - ${appointment.time}`;
          const isUrgent = minutesDiff <= 10;
          
          // Only show if not already shown (to prevent spam)
          if (!appointment.notificationShown || (isUrgent && !appointment.urgentNotificationShown)) {
            showAppointmentNotification(message, 'warning', isUrgent);
            
            if (isUrgent) {
              appointment.urgentNotificationShown = true;
            } else {
              appointment.notificationShown = true;
            }
            
            // Save updated appointments
            localStorage.setItem('appointments', JSON.stringify(appointments));
          }
        }
      });
    }

    function startAppointmentNotifications() {
      // Check every minute
      appointmentNotificationInterval = setInterval(checkUpcomingAppointments, 60000);
      // Check immediately on start
      checkUpcomingAppointments();
    }

    function stopAppointmentNotifications() {
      if (appointmentNotificationInterval) {
        clearInterval(appointmentNotificationInterval);
      }
    }

    function isTimeSlotAvailable(date, time, excludeIndex = -1) {
      const newDateTime = new Date(`${date}T${time}`);
      const newTime = newDateTime.getTime();

      for (let i = 0; i < appointments.length; i++) {
        if (i === excludeIndex) continue; // Skip the appointment being edited
        
        const existingDateTime = new Date(`${appointments[i].date}T${appointments[i].time}`);
        const existingTime = existingDateTime.getTime();
        const timeDiff = Math.abs(newTime - existingTime);
        const hoursDiff = timeDiff / (1000 * 60 * 60);

        // Check if less than 2 hours apart
        if (hoursDiff < 2) {
          return false;
        }
      }
      return true;
    }

    function populateServicesDropdown() {
      const dropdown = document.getElementById('servicesDropdown');
      if (!dropdown) return;

      dropdown.innerHTML = '';
      
      // Add services from allProducts (services available in POS)
      allProducts.forEach(product => {
        const option = document.createElement('div');
        option.className = 'multi-select-option';
        option.textContent = product.name;
        option.setAttribute('data-service', product.name);
        
        option.addEventListener('click', () => {
          toggleServiceSelection(product.name);
        });
        
        dropdown.appendChild(option);
      });

      // Add custom services from servicesData
      servicesData.forEach(service => {
        // Avoid duplicates
        if (!allProducts.find(p => p.name === service.name)) {
          const option = document.createElement('div');
          option.className = 'multi-select-option';
          option.textContent = service.name;
          option.setAttribute('data-service', service.name);
          
          option.addEventListener('click', () => {
            toggleServiceSelection(service.name);
          });
          
          dropdown.appendChild(option);
        }
      });
    }

    function toggleServiceSelection(serviceName) {
      const index = selectedServices.indexOf(serviceName);
      
      if (index === -1) {
        selectedServices.push(serviceName);
      } else {
        selectedServices.splice(index, 1);
      }
      
      updateServicesDisplay();
      updateServicesDropdownSelection();
    }

    function updateServicesDisplay() {
      const input = document.getElementById('servicesSelectInput');
      const selectedServicesContainer = document.getElementById('selectedServices');
      
      if (selectedServices.length === 0) {
        input.value = '';
        selectedServicesContainer.innerHTML = '';
        return;
      }
      
      input.value = `تم اختيار ${selectedServices.length} خدمة`;
      
      // Display service tags
      selectedServicesContainer.innerHTML = '';
      selectedServices.forEach(service => {
        const tag = document.createElement('div');
        tag.className = 'service-tag';
        tag.innerHTML = `
          <span>${service}</span>
          <span class="remove-btn" onclick="removeService('${service}')">&times;</span>
        `;
        selectedServicesContainer.appendChild(tag);
      });
    }

    function removeService(serviceName) {
      const index = selectedServices.indexOf(serviceName);
      if (index !== -1) {
        selectedServices.splice(index, 1);
        updateServicesDisplay();
        updateServicesDropdownSelection();
      }
    }

    function updateServicesDropdownSelection() {
      const options = document.querySelectorAll('.multi-select-option');
      options.forEach(option => {
        const serviceName = option.getAttribute('data-service');
        if (selectedServices.includes(serviceName)) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      });
    }

    function getAppointmentStatus(appointment) {
      const now = new Date();
      const appointmentDateTime = new Date(`${appointment.date}T${appointment.time}`);
      const timeDiff = appointmentDateTime.getTime() - now.getTime();
      const minutesDiff = Math.floor(timeDiff / (1000 * 60));

      if (timeDiff < 0) {
        return { status: 'منتهي', class: 'status-error' };
      } else if (minutesDiff <= 30) {
        return { status: 'قريب', class: 'status-warning' };
      } else {
        return { status: 'مجدول', class: 'status-success' };
      }
    }

    function updateAppointmentsTable() {
      const tbody = document.getElementById('appointmentsTableBody');
      tbody.innerHTML = '';
      
      if (appointments.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.className = 'text-center py-4 text-gray-500';
        td.textContent = 'لا توجد مواعيد مسجلة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      
      // Sort appointments by date and time
      const sortedAppointments = [...appointments].sort((a, b) => {
        const dateTimeA = new Date(`${a.date}T${a.time}`);
        const dateTimeB = new Date(`${b.date}T${b.time}`);
        return dateTimeA - dateTimeB;
      });
      
      sortedAppointments.forEach((appointment, index) => {
        const originalIndex = appointments.indexOf(appointment);
        const statusInfo = getAppointmentStatus(appointment);
        const servicesText = appointment.services ? appointment.services.join(', ') : 'غير محدد';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${appointment.date}</td>
          <td class="px-4 py-3">${appointment.time}</td>
          <td class="px-4 py-3">${appointment.customer}</td>
          <td class="px-4 py-3">${appointment.phone || 'غير محدد'}</td>
          <td class="px-4 py-3" title="${servicesText}">${servicesText.length > 30 ? servicesText.substring(0, 30) + '...' : servicesText}</td>
          <td class="px-4 py-3">
            <span class="status-badge ${statusInfo.class}">${statusInfo.status}</span>
          </td>
          <td class="px-4 py-3 text-center">
            <button data-index="${originalIndex}" class="deleteAppointmentBtn text-red-600 hover:text-red-800 focus:outline-none">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.deleteAppointmentBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (!confirmPasswordPrompt()) return;
          const idx = e.currentTarget.getAttribute('data-index');
          appointments.splice(idx, 1);
          localStorage.setItem('appointments', JSON.stringify(appointments));
          updateAppointmentsTable();
        });
      });
    }

    function initializeEnhancedAppointments() {
      updateAppointmentsTable();
      populateServicesDropdown();
      
      // Services dropdown toggle
      const servicesInput = document.getElementById('servicesSelectInput');
      const servicesDropdown = document.getElementById('servicesDropdown');
      
      servicesInput.addEventListener('click', () => {
        servicesDropdown.classList.toggle('hidden');
        populateServicesDropdown(); // Refresh services list
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.multi-select-container')) {
          servicesDropdown.classList.add('hidden');
        }
      });
      
      const appointmentForm = document.getElementById('appointmentForm');
      appointmentForm.addEventListener('submit', e => {
        e.preventDefault();
        const date = document.getElementById('appointmentDate').value;
        const time = document.getElementById('appointmentTime').value;
        const customer = document.getElementById('appointmentCustomer').value.trim();
        const phone = document.getElementById('appointmentPhone').value.trim();
        
        if (!date || !time || !customer || !phone) {
          alert('يرجى ملء جميع الحقول المطلوبة.');
          return;
        }

        if (selectedServices.length === 0) {
          alert('يرجى اختيار خدمة واحدة على الأقل.');
          return;
        }

        // Check time slot availability
        if (!isTimeSlotAvailable(date, time)) {
          alert('هذا الوقت غير متاح. يجب أن يكون هناك ساعتان على الأقل بين المواعيد.');
          return;
        }

        // Phone number validation (basic)
        const phoneRegex = /^[\d\+\-\s\(\)]+$/;
        if (!phoneRegex.test(phone)) {
          alert('يرجى إدخال رقم هاتف صحيح.');
          return;
        }
        
        const appointment = {
          date,
          time,
          customer,
          phone,
          services: [...selectedServices], // Copy selected services
          createdAt: new Date().toISOString(),
          notificationShown: false,
          urgentNotificationShown: false
        };
        
        appointments.push(appointment);
        localStorage.setItem('appointments', JSON.stringify(appointments));
        updateAppointmentsTable();
        
        // Reset form
        appointmentForm.reset();
        selectedServices = [];
        updateServicesDisplay();
        servicesDropdown.classList.add('hidden');
        
        alert('تم إضافة الموعد بنجاح!');
      });
      
      document.getElementById('deleteAllAppointmentsBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع المواعيد؟ لا يمكن التراجع عن هذا الإجراء.')) {
          appointments = [];
          localStorage.setItem('appointments', JSON.stringify(appointments));
          updateAppointmentsTable();
        }
      });
      
      // Start appointment notifications
      startAppointmentNotifications();
    }

    // Make removeService globally accessible
    window.removeService = removeService;

    // WhatsApp Functions
    function showWhatsAppNotification(message, type = 'success') {
      const container = document.getElementById('whatsappNotifications');
      const notification = document.createElement('div');
      notification.className = 'whatsapp-notification';
      
      const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
      notification.innerHTML = `
        <i class="fas ${icon}"></i>
        <div>
          <div class="font-semibold">${type === 'success' ? 'تم الإرسال بنجاح' : 'تنبيه'}</div>
          <div class="text-sm">${message}</div>
        
        </div>
      `;
      
      container.appendChild(notification);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
          if (container.contains(notification)) {
            container.removeChild(notification);
          }
        }, 500);
      }, 5000);
    }

    function sendWhatsAppMessage(invoiceData) {
      try {
        const { worker, customer, items, total, paymentMethod, date } = invoiceData;
        
        // Format the message
        let message = `🏪 *مركز الفارس للعناية بالرجل*\n`;
        message += `🧾 فاتورة جديدة\n\n`;
        message += `👤 *العامل:* ${worker}\n`;
        message += `🤵 *العميل:* ${customer}\n`;
        message += `📅 *التاريخ:* ${new Date(date).toLocaleDateString('ar-EG')}\n`;
        message += `⏰ *الوقت:* ${new Date(date).toLocaleTimeString('ar-EG')}\n`;
        message += `💳 *طريقة الدفع:* ${paymentMethod === 'cash' ? 'نقدي' : 'بطاقة'}\n\n`;
        
        message += `📋 *تفاصيل الخدمات:*\n`;
        items.forEach((item, index) => {
          const itemTotal = (item.price * item.quantity * (1 - item.discount / 100)).toFixed(2);
          message += `${index + 1}. ${item.name}\n`;
          message += `   الكمية: ${item.quantity} × ${item.price.toFixed(2)} ريال`;
          if (item.discount > 0) {
            message += ` (خصم ${item.discount}%)`;
          }
          message += `\n   الإجمالي: ${itemTotal} ريال\n\n`;
        });
        
        message += `💰 *المجموع الكلي: ${total} ريال*\n\n`;
        message += `🙏 شكراً لاختياركم مركز الفارس`;

        // Encode the message for URL
        const encodedMessage = encodeURIComponent(message);
        
        // Create WhatsApp URL
        const whatsappUrl = `https://wa.me/${WHATSAPP_PHONE}?text=${encodedMessage}`;
        
        // Open WhatsApp
        window.open(whatsappUrl, '_blank');
        
        // Show success notification
        showWhatsAppNotification(`تم إرسال تفاصيل الفاتورة إلى واتساب (${total} ريال)`);
        
        return true;
      } catch (error) {
        console.error('Error sending WhatsApp message:', error);
        showWhatsAppNotification('حدث خطأ أثناء إرسال الرسالة، يرجى المحاولة مرة أخرى', 'error');
        return false;
      }
    }

    // Utility Functions
    function saveValidUser() {
      localStorage.setItem('validUser', JSON.stringify(validUser));
    }

    // MODIFIED: Use separate delete password
    function confirmPasswordPrompt() {
      const input = prompt('يرجى إدخال كلمة المرور للحذف:');
      if (input === null) return false;
      if (input === DELETE_PASSWORD) return true;
      alert('كلمة المرور غير صحيحة.');
      return false;
    }

    function showPage(pageId) {
      pages.forEach((p) => {
        const el = document.getElementById(p);
        if (el) {
          if (p === pageId) {
            el.classList.remove('hidden');
            el.scrollTop = 0;
          } else {
            el.classList.add('hidden');
          }
        }
      });
      
      // Close mobile menu if open
      const mobileMenu = document.getElementById('mobileMenu');
      if (!mobileMenu.classList.contains('translate-x-full')) {
        mobileMenu.classList.add('translate-x-full');
      }
      
      // Update page-specific data
      if (pageId === 'dailySalary') {
        autoDisplayDailySalary();
      }
      if (pageId === 'reports') {
        updateReports();
        initializeMonthlyIncomeReport();
      }
      if (pageId === 'paymentSummary') {
        updatePaymentSummary();
      }
      if (pageId === 'inventory') {
        updateInventoryTable();
        updateStockMovementTable();
        populateProductSelect();
      }
      if (pageId === 'payrollManagement') {
        updatePayrollTable();
      }
      if (pageId === 'appointments') {
        updateAppointmentsTable();
        populateServicesDropdown();
      }
      if (pageId === 'services') {
        updateServicesTable();
      }
    }

    function showApp() {
      loginSection.classList.add('hidden');
      appContent.classList.remove('hidden');
      startAppointmentNotifications();
    }

    function showLogin() {
      loginSection.classList.remove('hidden');
      appContent.classList.add('hidden');
      formLogin.reset();
      loginError.textContent = '';
      loginError.classList.add('hidden');
      stopAppointmentNotifications();
    }

    function logout() {
      showLogin();
      showPage('home');
    }

    // Enhanced Authentication Functions
    function initializeAuth() {
      // Password toggle with enhanced animation
      const togglePassword = document.getElementById('togglePassword');
      const passwordInput = document.getElementById('password');
      const eyeIcon = document.getElementById('eyeIcon');
      
      togglePassword.addEventListener('click', () => {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.className = 'fas fa-eye-slash';
          togglePassword.style.color = '#3b82f6';
        } else {
          passwordInput.type = 'password';
          eyeIcon.className = 'fas fa-eye';
          togglePassword.style.color = '#6b7280';
        }
      });

      // Enhanced login form with better validation
      formLogin.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Clear any existing errors
        loginError.classList.add('hidden');
        
        const username = e.target.username.value.trim();
        const password = e.target.password.value;

        // Input validation with better feedback
        if (!username) {
          showLoginError('يرجى إدخال اسم المستخدم.');
          document.getElementById('username').focus();
          return;
        }

        if (!password) {
          showLoginError('يرجى إدخال كلمة المرور.');
          document.getElementById('password').focus();
          return;
        }

        if (password.length < 3) {
          showLoginError('كلمة المرور قصيرة جداً.');
          document.getElementById('password').focus();
          return;
        }

        // Authenticate user
        if (username === validUser.username && password === validUser.password) {
          // Success animation and login
          const loginBtn = e.target.querySelector('button[type="submit"]');
          loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري تسجيل الدخول...';
          loginBtn.disabled = true;
          
          setTimeout(() => {
            showApp();
            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> تسجيل الدخول';
            loginBtn.disabled = false;
          }, 1000);
        } else {
          showLoginError('اسم المستخدم أو كلمة المرور غير صحيحة');
          // Shake animation for wrong credentials
          const loginCard = document.querySelector('.login-card');
          loginCard.style.animation = 'shake 0.5s ease-in-out';
          setTimeout(() => {
            loginCard.style.animation = '';
          }, 500);
        }
      });

      // Enhanced logout buttons
      logoutBtn.addEventListener('click', logout);
      mobileLogoutBtn.addEventListener('click', () => {
        logout();
        document.getElementById('mobileMenu').classList.add('translate-x-full');
      });

      // Enhanced forgot password
      document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
        const userPhone = prompt('يرجى تسجيل رقم الهاتف لاستعادة كلمة المرور:');
        if (userPhone === null) return;
        
        const trimmedPhone = userPhone.trim();
        if (trimmedPhone === phoneNumber) {
          alert(`✅ رقم الهاتف صحيح.\n🔑 كلمة المرور الخاصة بك هي: ${validUser.password}`);
        } else if (trimmedPhone === '') {
          alert('❌ لم يتم إدخال رقم الهاتف.');
        } else {
          alert('❌ رقم الهاتف غير صحيح. يرجى المحاولة مرة أخرى.');
        }
      });

      // Enhanced change password modal
      initializeChangePasswordModal();
    }

    function showLoginError(message) {
      const loginError = document.getElementById('loginError');
      loginError.textContent = message;
      loginError.classList.remove('hidden');
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        loginError.classList.add('hidden');
      }, 5000);
    }

    function initializeChangePasswordModal() {
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      const changePasswordModal = document.getElementById('changePasswordModal');
      const closeChangePasswordModal = document.getElementById('closeChangePasswordModal');
      const cancelChangePasswordBtn = document.getElementById('cancelChangePasswordBtn');
      const changePasswordForm = document.getElementById('changePasswordForm');
      const changePasswordError = document.getElementById('changePasswordError');
      const changePasswordSuccess = document.getElementById('changePasswordSuccess');

      changePasswordBtn.addEventListener('click', () => {
        changePasswordError.classList.add('hidden');
        changePasswordSuccess.classList.add('hidden');
        changePasswordForm.reset();
        changePasswordModal.classList.remove('hidden');
        document.getElementById('phoneInput').focus();
      });

      closeChangePasswordModal.addEventListener('click', () => {
        changePasswordModal.classList.add('hidden');
        resetChangePasswordForm();
      });

      cancelChangePasswordBtn.addEventListener('click', () => {
        changePasswordModal.classList.add('hidden');
        resetChangePasswordForm();
      });

      // Close modal when clicking outside
      changePasswordModal.addEventListener('click', (e) => {
        if (e.target === changePasswordModal) {
          changePasswordModal.classList.add('hidden');
          resetChangePasswordForm();
        }
      });

      changePasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        changePasswordError.classList.add('hidden');
        changePasswordSuccess.classList.add('hidden');

        const phone = document.getElementById('phoneInput').value.trim();
        const oldPass = document.getElementById('oldPasswordInput').value;
        const newPass = document.getElementById('newPasswordInput').value;

        // Enhanced validation
        if (!phone || !oldPass || !newPass) {
          showChangePasswordError('يرجى ملء جميع الحقول.');
          return;
        }
        
        if (phone !== phoneNumber) {
          showChangePasswordError('رقم الهاتف غير صحيح.');
          return;
        }
        
        if (oldPass !== validUser.password) {
          showChangePasswordError('كلمة المرور القديمة غير صحيحة.');
          return;
        }
        
        if (newPass.length < 6) {
          showChangePasswordError('كلمة المرور الجديدة يجب أن تكون 6 أحرف على الأقل.');
          return;
        }
        
        if (newPass === oldPass) {
          showChangePasswordError('كلمة المرور الجديدة يجب أن تختلف عن القديمة.');
          return;
        }

        // Update password
        validUser.password = newPass;
        saveValidUser();
        
        showChangePasswordSuccess('✅ تم تغيير كلمة المرور بنجاح!');
        
        setTimeout(() => {
          changePasswordModal.classList.add('hidden');
          resetChangePasswordForm();
          alert('تم تغيير كلمة المرور بنجاح. يرجى تسجيل الدخول باستخدام كلمة المرور الجديدة.');
          showLogin();
        }, 2000);
      });
    }

    function showChangePasswordError(message) {
      const errorEl = document.getElementById('changePasswordError');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function showChangePasswordSuccess(message) {
      const successEl = document.getElementById('changePasswordSuccess');
      successEl.textContent = message;
      successEl.classList.remove('hidden');
    }

    function resetChangePasswordForm() {
      document.getElementById('changePasswordForm').reset();
      document.getElementById('changePasswordError').classList.add('hidden');
      document.getElementById('changePasswordSuccess').classList.add('hidden');
    }

    // Navigation Functions
    function initializeNavigation() {
      // Mobile menu toggle
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.remove('translate-x-full');
      });

      mobileMenuClose.addEventListener('click', () => {
        mobileMenu.classList.add('translate-x-full');
      });

      // Header nav buttons
      document.querySelectorAll('header nav button:not(#logoutBtn)').forEach((btn) => {
        btn.addEventListener('click', () => {
          const page = btn.getAttribute('data-page');
          if (page) showPage(page);
        });
      });

      // Mobile nav buttons
      document.querySelectorAll('#mobileMenu nav button:not(#mobileLogoutBtn)').forEach((btn) => {
        btn.addEventListener('click', () => {
          const page = btn.getAttribute('data-page');
          if (page) showPage(page);
        });
      });

      // Home cards clickable
      document.querySelectorAll('#home > div[tabindex="0"]').forEach((card) => {
        card.addEventListener('click', () => {
          const page = card.getAttribute('data-page');
          if (page) showPage(page);
        });
        
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const page = card.getAttribute('data-page');
            if (page) showPage(page);
          }
        });
      });

      // Back buttons
      pages.forEach((p) => {
        if (p === 'home') return;
        const backBtn = document.getElementById('backFrom' + p.charAt(0).toUpperCase() + p.slice(1));
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            showPage('home');
          });
        }
      });
    }

    // Payroll Management Functions - MODIFIED FOR MANUAL INPUT
    function calculateMonthlyWithdrawalsForWorker(workerName, month) {
      return withdrawals
        .filter(wd => wd.workerName === workerName && wd.date.startsWith(month))
        .reduce((sum, wd) => sum + parseFloat(wd.amount), 0);
    }

    function updatePayrollTable() {
      const tbody = document.getElementById('payrollTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';
      
      if (payrollRecords.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 9;
        td.className = 'text-center py-4 text-gray-500';
        td.textContent = 'لا توجد سجلات رواتب محسوبة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      
      payrollRecords.forEach((record, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${record.workerName}</td>
          <td class="px-4 py-3">${parseFloat(record.baseSalary).toFixed(2)}</td>
          <td class="px-4 py-3">${parseFloat(record.percentage).toFixed(1)}%</td>
          <td class="px-4 py-3">${parseFloat(record.additionalAmount).toFixed(2)}</td>
          <td class="px-4 py-3">${parseFloat(record.monthlyWithdrawals).toFixed(2)}</td>
          <td class="px-4 py-3 font-bold ${record.netSalary < 0 ? 'text-red-600' : 'text-green-600'}">${parseFloat(record.netSalary).toFixed(2)}</td>
          <td class="px-4 py-3">${record.month}</td>
          <td class="px-4 py-3">${new Date(record.calculatedDate).toLocaleDateString('ar-EG')}</td>
          <td class="px-4 py-3 text-center">
            <button data-index="${index}" class="deletePayrollBtn text-red-600 hover:text-red-800 focus:outline-none">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.deletePayrollBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (!confirmPasswordPrompt()) return;
          const idx = e.currentTarget.getAttribute('data-index');
          payrollRecords.splice(idx, 1);
          localStorage.setItem('payrollRecords', JSON.stringify(payrollRecords));
          updatePayrollTable();
        });
      });
    }

    function initializePayrollManagement() {
      const payrollForm = document.getElementById('payrollForm');
      const payrollResult = document.getElementById('payrollResult');
      const payrollResultContent = document.getElementById('payrollResultContent');

      // Set current month as default
      const currentDate = new Date();
      const currentMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
      document.getElementById('payrollMonth').value = currentMonth;

      payrollForm.addEventListener('submit', e => {
        e.preventDefault();
        
        const workerName = document.getElementById('payrollWorker').value.trim();
        const baseSalary = parseFloat(document.getElementById('payrollBaseSalary').value);
        const percentage = parseFloat(document.getElementById('payrollPercentage').value);
        const additionalAmount = parseFloat(document.getElementById('payrollAdditionalAmount').value) || 0;
        const month = document.getElementById('payrollMonth').value;
        
        if (!workerName || isNaN(baseSalary) || isNaN(percentage) || !month) {
          alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح.');
          return;
        }

        if (baseSalary < 0 || percentage < 0 || additionalAmount < 0) {
          alert('لا يمكن أن تكون القيم المدخلة أقل من صفر.');
          return;
        }

        if (percentage > 200) {
          alert('النسبة المئوية لا يمكن أن تتجاوز 200%.');
          return;
        }

        // Calculate monthly withdrawals
        const monthlyWithdrawals = calculateMonthlyWithdrawalsForWorker(workerName, month);
        
        // Calculate net salary using the formula: (BaseSalary × Percentage%) + AdditionalAmount - MonthlyWithdrawals
        const salaryByPercentage = baseSalary * (percentage / 100);
        const netSalary = salaryByPercentage + additionalAmount - monthlyWithdrawals;

        // Create record
        const record = {
          workerName,
          baseSalary,
          percentage,
          additionalAmount,
          monthlyWithdrawals,
          netSalary,
          month,
          calculatedDate: new Date().toISOString()
        };

        // Save record
        payrollRecords.push(record);
        localStorage.setItem('payrollRecords', JSON.stringify(payrollRecords));

        // Display results
        payrollResultContent.innerHTML = `
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <p class="text-sm text-blue-600 font-semibold">اسم الموظف</p>
            <p class="text-lg font-bold text-blue-800">${workerName}</p>
          </div>
          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <p class="text-sm text-green-600 font-semibold">الراتب بعد النسبة</p>
            <p class="text-lg font-bold text-green-800">${salaryByPercentage.toFixed(2)} ريال</p>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
            <p class="text-sm text-purple-600 font-semibold">المبلغ الإضافي</p>
            <p class="text-lg font-bold text-purple-800">${additionalAmount.toFixed(2)} ريال</p>
          </div>
          <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <p class="text-sm text-red-600 font-semibold">السحب الشهري</p>
            <p class="text-lg font-bold text-red-800">${monthlyWithdrawals.toFixed(2)} ريال</p>
          </div>
          <div class="md:col-span-2 lg:col-span-4 bg-gradient-to-r from-emerald-50 to-teal-50 p-6 rounded-lg border-2 border-emerald-300">
            <p class="text-lg text-emerald-700 font-semibold mb-2">صافي الراتب النهائي</p>
            <p class="text-3xl font-bold ${netSalary < 0 ? 'text-red-600' : 'text-emerald-600'}">${netSalary.toFixed(2)} ريال</p>
            <p class="text-sm text-gray-600 mt-2">
              المعادلة: (${baseSalary.toFixed(2)} × ${percentage}%) + ${additionalAmount.toFixed(2)} - ${monthlyWithdrawals.toFixed(2)} = ${netSalary.toFixed(2)}
            </p>
          </div>
        `;

        payrollResult.classList.remove('hidden');
        updatePayrollTable();
        payrollForm.reset();
        
        //Reset to current month
        document.getElementById('payrollMonth').value = currentMonth;
        document.getElementById('payrollPercentage').value = 100;
        document.getElementById('payrollAdditionalAmount').value = 0;
      });

      // Delete all payroll records
      document.getElementById('deleteAllPayrollBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع سجلات الرواتب المحسوبة؟ لا يمكن التراجع عن هذا الإجراء.')) {
          payrollRecords = [];
          localStorage.setItem('payrollRecords', JSON.stringify(payrollRecords));
          updatePayrollTable();
          payrollResult.classList.add('hidden');
        }
      });

      updatePayrollTable();
    }

    // Inventory Functions
    function getProductCurrentStock(productName) {
      const movements = stockMovements.filter(m => m.productName === productName);
      let totalAdded = 0;
      let totalWithdrawn = 0;
      
      movements.forEach(movement => {
        if (movement.type === 'add') {
          totalAdded += movement.quantity;
        } else if (movement.type === 'withdraw') {
          totalWithdrawn += movement.quantity;
        }
      });
      
      return {
        totalAdded,
        totalWithdrawn,
        currentStock: totalAdded - totalWithdrawn
      };
    }

    function getStockStatusClass(currentStock) {
      if (currentStock <= 5) return 'status-error';
      if (currentStock <= 20) return 'status-warning';
      return 'status-success';
    }

    function getStockStatusText(currentStock) {
      if (currentStock <= 0) return 'نفد المخزون';
      if (currentStock <= 5) return 'مخزون منخفض';
      if (currentStock <= 20) return 'مخزون متوسط';
      return 'مخزون جيد';
    }

    function updateInventoryTable() {
      const tbody = document.getElementById('inventoryTableBody');
      tbody.innerHTML = '';
      
      if (inventory.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.className = 'text-center py-4 text-gray-500';
        td.textContent = 'لا توجد منتجات مسجلة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      
      inventory.forEach((item, index) => {
        const stockInfo = getProductCurrentStock(item.name);
        const statusClass = getStockStatusClass(stockInfo.currentStock);
        const statusText = getStockStatusText(stockInfo.currentStock);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${item.name}</td>
          <td class="px-4 py-3 text-green-600 font-semibold">${stockInfo.totalAdded}</td>
          <td class="px-4 py-3 text-red-600 font-semibold">${stockInfo.totalWithdrawn}</td>
          <td class="px-4 py-3 font-bold">${stockInfo.currentStock}</td>
          <td class="px-4 py-3">${parseFloat(item.price).toFixed(2)}</td>
          <td class="px-4 py-3">
            <span class="status-badge ${statusClass}">${statusText}</span>
          </td>
          <td class="px-4 py-3 text-center">
            <button data-index="${index}" class="deleteInventoryBtn text-red-600 hover:text-red-800 focus:outline-none">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.deleteInventoryBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (!confirmPasswordPrompt()) return;
          const idx = e.currentTarget.getAttribute('data-index');
          const productName = inventory[idx].name;
          
          // Remove product from inventory
          inventory.splice(idx, 1);
          localStorage.setItem('inventory', JSON.stringify(inventory));
          
          // Remove all stock movements for this product
          stockMovements = stockMovements.filter(m => m.productName !== productName);
          localStorage.setItem('stockMovements', JSON.stringify(stockMovements));
          
          updateInventoryTable();
          updateStockMovementTable();
          populateProductSelect();
        });
      });
    }

    function updateStockMovementTable() {
      const tbody = document.getElementById('stockMovementTableBody');
      tbody.innerHTML = '';
      
      if (stockMovements.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'text-center py-4 text-gray-500';
        td.textContent = 'لا توجد حركات مخزون مسجلة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      
      // Sort movements by date (newest first)
      const sortedMovements = [...stockMovements].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedMovements.forEach((movement, index) => {
        const typeText = movement.type === 'add' ? 'إضافة' : 'سحب';
        const typeClass = movement.type === 'add' ? 'text-green-600' : 'text-red-600';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${movement.date}</td>
          <td class="px-4 py-3">${movement.productName}</td>
          <td class="px-4 py-3 ${typeClass} font-semibold">${typeText}</td>
          <td class="px-4 py-3">${movement.quantity}</td>
          <td class="px-4 py-3">${movement.note || '-'}</td>
          <td class="px-4 py-3 text-center">
            <button data-index="${stockMovements.indexOf(movement)}" class="deleteMovementBtn text-red-600 hover:text-red-800 focus:outline-none">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.deleteMovementBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (!confirmPasswordPrompt()) return;
          const idx = e.currentTarget.getAttribute('data-index');
          stockMovements.splice(idx, 1);
          localStorage.setItem('stockMovements', JSON.stringify(stockMovements));
          updateStockMovementTable();
          updateInventoryTable();
        });
      });
    }

    function populateProductSelect() {
      const select = document.getElementById('movementProduct');
      if (!select) return;
      
      // Clear existing options except the first one
      while (select.children.length > 1) {
        select.removeChild(select.lastChild);
      }
      
      inventory.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.name;
        select.appendChild(option);
      });
    }

    function initializeInventory() {
      updateInventoryTable();
      updateStockMovementTable();
      populateProductSelect();
      
      // Add new product form
      const inventoryForm = document.getElementById('inventoryForm');
      inventoryForm.addEventListener('submit', e => {
        e.preventDefault();
        const name = document.getElementById('productName').value.trim();
        const quantity = parseInt(document.getElementById('productQuantity').value);
        const price = parseFloat(document.getElementById('productPrice').value);
        
        if (!name || isNaN(quantity) || quantity < 0 || isNaN(price) || price < 0) {
          alert('يرجى ملء جميع الحقول بشكل صحيح.');
          return;
        }
        
        // Check if product already exists
        const existingIndex = inventory.findIndex(item => item.name.toLowerCase() === name.toLowerCase());
        if (existingIndex !== -1) {
          alert('هذا المنتج موجود بالفعل. استخدم نموذج حركة المخزون لإضافة كمية.');
          return;
        }
        
        // Add product to inventory
        inventory.push({ name, price });
        localStorage.setItem('inventory', JSON.stringify(inventory));
        
        // Add initial stock movement if quantity > 0
        if (quantity > 0) {
          const movement = {
            date: new Date().toISOString().split('T')[0],
            productName: name,
            type: 'add',
            quantity: quantity,
            note: 'إضافة أولية'
          };
          stockMovements.push(movement);
          localStorage.setItem('stockMovements', JSON.stringify(stockMovements));
        }
        
        updateInventoryTable();
        updateStockMovementTable();
        populateProductSelect();
        inventoryForm.reset();
      });
      
      // Stock movement form
      const stockMovementForm = document.getElementById('stockMovementForm');
      stockMovementForm.addEventListener('submit', e => {
        e.preventDefault();
        const productName = document.getElementById('movementProduct').value;
        const type = document.getElementById('movementType').value;
        const quantity = parseInt(document.getElementById('movementQuantity').value);
        const note = document.getElementById('movementNote').value.trim();
        
        if (!productName || !type || isNaN(quantity) || quantity <= 0) {
          alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح.');
          return;
        }
        
        // Check if withdrawal is possible
        if (type === 'withdraw') {
          const stockInfo = getProductCurrentStock(productName);
          if (quantity > stockInfo.currentStock) {
            alert(`لا يمكن سحب ${quantity} قطعة. المخزون الحالي: ${stockInfo.currentStock}`);
            return;
          }
        }
        
        const movement = {
          date: new Date().toISOString().split('T')[0],
          productName,
          type,
          quantity,
          note
        };
        
        stockMovements.push(movement);
        localStorage.setItem('stockMovements', JSON.stringify(stockMovements));
        
        updateInventoryTable();
        updateStockMovementTable();
        stockMovementForm.reset();
      });
      
      // Delete all movements button
      document.getElementById('deleteAllMovementsBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع حركات المخزون؟ لا يمكن التراجع عن هذا الإجراء.')) {
          stockMovements = [];
          localStorage.setItem('stockMovements', JSON.stringify(stockMovements));
          updateStockMovementTable();
          updateInventoryTable();
        }
      });
      
      // Delete all inventory button
      document.getElementById('deleteAllInventoryBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع المنتجات وحركات المخزون؟ لا يمكن التراجع عن هذا الإجراء.')) {
          inventory = [];
          stockMovements = [];
          localStorage.setItem('inventory', JSON.stringify(inventory));
          localStorage.setItem('stockMovements', JSON.stringify(stockMovements));
          updateInventoryTable();
          updateStockMovementTable();
          populateProductSelect();
        }
      });
    }

    // Expenses Functions
    function updateExpensesTable() {
      const tbody = document.getElementById('expensesTableBody');
      tbody.innerHTML = '';
      
      if (expenses.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.className = 'text-center py-4 text-gray-500';
        td.textContent = 'لا توجد مصروفات مسجلة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      
      expenses.forEach((expense, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${expense.date}</td>
          <td class="px-4 py-3">${expense.category}</td>
          <td class="px-4 py-3">${parseFloat(expense.amount).toFixed(2)}</td>
          <td class="px-4 py-3">${expense.description || ''}</td>
          <td class="px-4 py-3 text-center">
            <button data-index="${index}" class="deleteExpenseBtn text-red-600 hover:text-red-800 focus:outline-none">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.deleteExpenseBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (!confirmPasswordPrompt()) return;
          const idx = e.currentTarget.getAttribute('data-index');
          expenses.splice(idx, 1);
          localStorage.setItem('expenses', JSON.stringify(expenses));
          updateExpensesTable();
        });
      });
    }

    function initializeExpenses() {
      updateExpensesTable();
      
      const expenseForm = document.getElementById('expenseForm');
      expenseForm.addEventListener('submit', e => {
        e.preventDefault();
        const date = document.getElementById('expenseDate').value;
        const category = document.getElementById('expenseCategory').value;
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const description = document.getElementById('expenseDescription').value.trim();
        
        if (!date || !category || isNaN(amount) || amount < 0) {
          alert('يرجى ملء جميع الحقول بشكل صحيح.');
          return;
        }
        
        expenses.push({ date, category, amount, description });
        localStorage.setItem('expenses', JSON.stringify(expenses));
        updateExpensesTable();
        expenseForm.reset();
      });
      
      document.getElementById('deleteAllExpensesBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع المصروفات؟ لا يمكن التراجع عن هذا الإجراء.')) {
          expenses = [];
          localStorage.setItem('expenses', JSON.stringify(expenses));
          updateExpensesTable();
        }
      });
    }

    // Withdrawals Functions - MODIFIED FOR MANUAL INPUT
    function updateWithdrawalsTable() {
      const tbody = document.getElementById('withdrawalsTableBody');
      tbody.innerHTML = '';
      
      if (withdrawals.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.className = 'text-center py-4 text-gray-500';
        td.textContent = 'لا توجد عمليات سحب مسجلة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        document.getElementById('monthlyWithdrawalSummary').classList.add('hidden');
        return;
      }
      
      withdrawals.forEach((withdrawal, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${withdrawal.date}</td>
          <td class="px-4 py-3">${withdrawal.workerName}</td>
          <td class="px-4 py-3">${parseFloat(withdrawal.amount).toFixed(2)}</td>
          <td class="px-4 py-3 text-center">
            <button data-index="${index}" class="deleteWithdrawalBtn text-red-600 hover:text-red-800 focus:outline-none">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.deleteWithdrawalBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (!confirmPasswordPrompt()) return;
          const idx = e.currentTarget.getAttribute('data-index');
          withdrawals.splice(idx, 1);
          localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
          updateWithdrawalsTable();
        });
      });
    }

    function calculateMonthlyWithdrawals() {
      const withdrawalTotals = {};
      withdrawals.forEach(wd => {
        const month = wd.date.slice(0, 7);
        const key = wd.workerName + '|' + month;
        if (!withdrawalTotals[key]) withdrawalTotals[key] = 0;
        withdrawalTotals[key] += wd.amount;
      });

      const content = document.getElementById('monthlyWithdrawalContent');
      content.innerHTML = '';
      
      for (const key in withdrawalTotals) {
        const [workerName, month] = key.split('|');
        const amount = withdrawalTotals[key];
        
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center py-2 border-b border-red-200';
        div.innerHTML = `
          <span class="font-semibold">${workerName} - ${month}</span>
          <span class="font-bold">${amount.toFixed(2)} ريال</span>
        `;
        content.appendChild(div);
      }
      
      document.getElementById('monthlyWithdrawalSummary').classList.remove('hidden');
    }

    function initializeWithdrawals() {
      updateWithdrawalsTable();
      
      const withdrawalForm = document.getElementById('withdrawalForm');
      withdrawalForm.addEventListener('submit', e => {
        e.preventDefault();
        const date = document.getElementById('withdrawalDate').value;
        const workerName = document.getElementById('withdrawalWorker').value.trim();
        const amount = parseFloat(document.getElementById('withdrawalAmount').value);
        
        if (!date || !workerName || isNaN(amount) || amount < 0) {
          alert('يرجى ملء جميع الحقول بشكل صحيح.');
          return;
        }
        
        withdrawals.push({ date, workerName, amount });
        localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
        updateWithdrawalsTable();
        withdrawalForm.reset();
      });
      
      document.getElementById('calculateMonthlyWithdrawalsBtn').addEventListener('click', calculateMonthlyWithdrawals);
      
      document.getElementById('deleteAllWithdrawalsBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع عمليات السحب؟ لا يمكن التراجع عن هذا الإجراء.')) {
          withdrawals = [];
          localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
          updateWithdrawalsTable();
        }
      });
    }

    // Services Functions
    function updateServicesTable() {
      const tbody = document.getElementById('servicesTableBody');
      tbody.innerHTML = '';
      
      if (servicesData.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.className = 'text-center py-4 text-gray-500';
        td.textContent = 'لا توجد خدمات مسجلة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      
      servicesData.forEach((service, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${service.name}</td>
          <td class="px-4 py-3">${parseFloat(service.price).toFixed(2)}</td>
          <td class="px-4 py-3 text-center">
            <button data-index="${index}" class="deleteServiceBtn text-red-600 hover:text-red-800 focus:outline-none">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.deleteServiceBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (!confirmPasswordPrompt()) return;
          const idx = e.currentTarget.getAttribute('data-index');
          servicesData.splice(idx, 1);
          localStorage.setItem('services', JSON.stringify(servicesData));
          updateServicesTable();
          // Update services dropdown in appointments
          populateServicesDropdown();
        });
      });
    }

    function initializeServices() {
      updateServicesTable();
      
      const serviceForm = document.getElementById('serviceForm');
      serviceForm.addEventListener('submit', e => {
        e.preventDefault();
        const name = document.getElementById('serviceName').value.trim();
        const price = parseFloat(document.getElementById('servicePriceInput').value);
        
        if (!name || isNaN(price) || price < 0) {
          alert('يرجى ملء جميع الحقول بشكل صحيح.');
          return;
        }
        
        servicesData.push({ name, price });
        localStorage.setItem('services', JSON.stringify(servicesData));
        updateServicesTable();
        serviceForm.reset();
        // Update services dropdown in appointments
        populateServicesDropdown();
      });
      
      document.getElementById('deleteAllServicesBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع الخدمات؟ لا يمكن التراجع عن هذا الإجراء.')) {
          servicesData = [];
          localStorage.setItem('services', JSON.stringify(servicesData));
          updateServicesTable();
          // Update services dropdown in appointments
          populateServicesDropdown();
        }
      });
    }

    // Monthly Income Report Functions
    function generateMonthlyIncomeReport(selectedMonth) {
      if (!selectedMonth) {
        alert('يرجى اختيار شهر لإنشاء التقرير.');
        return;
      }

      // Filter invoices for the selected month
      const monthlyInvoices = printedInvoices.filter(invoice => {
        const invoiceDate = new Date(invoice.date);
        const invoiceMonth = invoiceDate.getFullYear() + '-' + String(invoiceDate.getMonth() + 1).padStart(2, '0');
        return invoiceMonth === selectedMonth;
      });

      // Calculate totals
      let totalSales = 0;
      let cashSales = 0;
      let visaSales = 0;
      const workerSales = {};
      const dailySales = {};

      monthlyInvoices.forEach(invoice => {
        const total = parseFloat(invoice.total);
        totalSales += total;

        // Payment method breakdown
        if (invoice.paymentMethod === 'cash') {
          cashSales += total;
        } else if (invoice.paymentMethod === 'visa') {
          visaSales += total;
        }

        // Worker breakdown
        const workerName = invoice.worker || 'غير محدد';
        if (!workerSales[workerName]) {
          workerSales[workerName] = {
            totalSales: 0,
            invoiceCount: 0,
            cashSales: 0,
            visaSales: 0
          };
        }
        workerSales[workerName].totalSales += total;
        workerSales[workerName].invoiceCount += 1;
        if (invoice.paymentMethod === 'cash') {
          workerSales[workerName].cashSales += total;
        } else if (invoice.paymentMethod === 'visa') {
          workerSales[workerName].visaSales += total;
        }

        // Daily breakdown
        const invoiceDate = new Date(invoice.date);
        const dayKey = invoiceDate.getDate();
        if (!dailySales[dayKey]) {
          dailySales[dayKey] = {
            totalSales: 0,
            invoiceCount: 0,
            cashSales: 0,
            visaSales: 0
          };
        }
        dailySales[dayKey].totalSales += total;
        dailySales[dayKey].invoiceCount += 1;
        if (invoice.paymentMethod === 'cash') {
          dailySales[dayKey].cashSales += total;
        } else if (invoice.paymentMethod === 'visa') {
          dailySales[dayKey].visaSales += total;
        }
      });

      // Update summary cards
      document.getElementById('monthlyTotalSales').textContent = totalSales.toFixed(2) + ' ريال';
      document.getElementById('monthlyCashSales').textContent = cashSales.toFixed(2) + ' ريال';
      document.getElementById('monthlyVisaSales').textContent = visaSales.toFixed(2) + ' ريال';
      document.getElementById('monthlyInvoicesCount').textContent = monthlyInvoices.length;

      // Update worker breakdown table
      const workerTableBody = document.getElementById('monthlyIncomeByWorkerBody');
      workerTableBody.innerHTML = '';

      if (Object.keys(workerSales).length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td colspan="5" class="text-center py-4 text-gray-500">
            لا توجد مبيعات في الشهر المحدد
          </td>
        `;
        workerTableBody.appendChild(tr);
      } else {
        Object.entries(workerSales).forEach(([workerName, data]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-4 py-3">${workerName}</td>
            <td class="px-4 py-3 text-center">${data.invoiceCount}</td>
            <td class="px-4 py-3 font-bold text-green-600">${data.totalSales.toFixed(2)}</td>
            <td class="px-4 py-3 text-green-600">${data.cashSales.toFixed(2)}</td>
            <td class="px-4 py-3 text-blue-600">${data.visaSales.toFixed(2)}</td>
          `;
          workerTableBody.appendChild(tr);
        });
      }

      // Update daily breakdown table
      const dailyTableBody = document.getElementById('dailyIncomeBreakdownBody');
      dailyTableBody.innerHTML = '';

      if (Object.keys(dailySales).length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td colspan="5" class="text-center py-4 text-gray-500">
            لا توجد مبيعات في الشهر المحدد
          </td>
        `;
        dailyTableBody.appendChild(tr);
      } else {
        // Sort days numerically
        const sortedDays = Object.keys(dailySales).sort((a, b) => parseInt(a) - parseInt(b));
        
        sortedDays.forEach(day => {
          const data = dailySales[day];
          const [year, month] = selectedMonth.split('-');
          const fullDate = `${year}-${month}-${String(day).padStart(2, '0')}`;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-4 py-3">${new Date(fullDate).toLocaleDateString('ar-EG')}</td>
            <td class="px-4 py-3 text-center">${data.invoiceCount}</td>
            <td class="px-4 py-3 font-bold text-green-600">${data.totalSales.toFixed(2)}</td>
            <td class="px-4 py-3 text-green-600">${data.cashSales.toFixed(2)}</td>
            <td class="px-4 py-3 text-blue-600">${data.visaSales.toFixed(2)}</td>
          `;
          dailyTableBody.appendChild(tr);
        });
      }
    }

    function initializeMonthlyIncomeReport() {
      // Set current month as default
      const currentDate = new Date();
      const currentMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
      document.getElementById('incomeReportMonth').value = currentMonth;

      // Generate report button
      document.getElementById('generateIncomeReportBtn').addEventListener('click', () => {
        const selectedMonth = document.getElementById('incomeReportMonth').value;
        generateMonthlyIncomeReport(selectedMonth);
      });

      // Generate report for current month by default
      generateMonthlyIncomeReport(currentMonth);
    }

    function updateReports() {
      // Expenses Report
      const expenseCategoryTotals = {};
      expenses.forEach((exp) => {
        if (!expenseCategoryTotals[exp.category]) expenseCategoryTotals[exp.category] = 0;
        expenseCategoryTotals[exp.category] += exp.amount;
      });
      const totalExpenses = Object.values(expenseCategoryTotals).reduce((sum, amount) => sum + amount, 0);

      const expenseReportBody = document.getElementById('expenseReportBody');
      expenseReportBody.innerHTML = '';
      for (const category in expenseCategoryTotals) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${category}</td>
          <td class="px-4 py-3">${expenseCategoryTotals[category].toFixed(2)}</td>
        `;
        expenseReportBody.appendChild(tr);
      }
      document.getElementById('totalExpenses').textContent = totalExpenses.toFixed(2);

      // Payroll Report
      const payrollReportBody = document.getElementById('payrollReportBody');
      payrollReportBody.innerHTML = '';
      payrollRecords.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${record.workerName}</td>
          <td class="px-4 py-3">${parseFloat(record.baseSalary).toFixed(2)}</td>
          <td class="px-4 py-3">${parseFloat(record.percentage).toFixed(1)}%</td>
          <td class="px-4 py-3">${parseFloat(record.additionalAmount).toFixed(2)}</td>
          <td class="px-4 py-3">${parseFloat(record.monthlyWithdrawals).toFixed(2)}</td>
          <td class="px-4 py-3 font-bold ${record.netSalary < 0 ? 'text-red-600' : 'text-green-600'}">${parseFloat(record.netSalary).toFixed(2)}</td>
          <td class="px-4 py-3">${record.month}</td>
          <td class="px-4 py-3">${new Date(record.calculatedDate).toLocaleDateString('ar-EG')}</td>
        `;
        payrollReportBody.appendChild(tr);
      });

      // Withdrawals Report
      const withdrawalReportBody = document.getElementById('withdrawalReportBody');
      const withdrawalTotals = {};
      withdrawals.forEach((wd) => {
        const month = wd.date.slice(0, 7);
        const key = wd.workerName + '|' + month;
        if (!withdrawalTotals[key]) withdrawalTotals[key] = 0;
        withdrawalTotals[key] += wd.amount;
      });
      withdrawalReportBody.innerHTML = '';
      let totalWithdrawalsAmount = 0;
      for (const key in withdrawalTotals) {
        const [workerName, month] = key.split('|');
        const amount = withdrawalTotals[key];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${workerName}</td>
          <td class="px-4 py-3">${month}</td>
          <td class="px-4 py-3">${amount.toFixed(2)}</td>
        `;
        withdrawalReportBody.appendChild(tr);
        totalWithdrawalsAmount += amount;
      }
      document.getElementById('totalWithdrawals').textContent = totalWithdrawalsAmount.toFixed(2);

      // Invoices Report
      const invoiceStats = printedInvoices.reduce(
        (acc, invoice) => {
          const total = parseFloat(invoice.total);
          acc.totalInvoices += 1;
          acc.totalAmount += total;
          if (invoice.paymentMethod === 'cash') {
            acc.cashAmount += total;
          } else if (invoice.paymentMethod === 'visa') {
            acc.visaAmount += total;
          }
          return acc;
        },
        { totalInvoices: 0, totalAmount: 0, cashAmount: 0, visaAmount: 0 }
      );

      document.getElementById('totalInvoicesCount').textContent = invoiceStats.totalInvoices;
      document.getElementById('totalInvoicesAmount').textContent = invoiceStats.totalAmount.toFixed(2) + ' ريال';
      document.getElementById('totalCashInvoices').textContent = invoiceStats.cashAmount.toFixed(2) + ' ريال';
      document.getElementById('totalVisaInvoices').textContent = invoiceStats.visaAmount.toFixed(2) + ' ريال';

      // Invoice worker totals
      const invoiceWorkerTotals = printedInvoices.reduce((acc, invoice) => {
        const workerName = invoice.worker || 'غير محدد';
        acc[workerName] = (acc[workerName] || 0) + parseFloat(invoice.total);
        return acc;
      }, {});

      const invoiceWorkerReportBody = document.getElementById('invoiceWorkerReportBody');
      invoiceWorkerReportBody.innerHTML = '';

      for (const workerName in invoiceWorkerTotals) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3">${workerName}</td>
          <td class="px-4 py-3">${invoiceWorkerTotals[workerName].toFixed(2)}</td>
        `;
        invoiceWorkerReportBody.appendChild(tr);
      }
    }

    // Print all reports function with full implementation including monthly income
    function printAllReports() {
      
      // Calculate all totals
      const expenseCategoryTotals = {};
      expenses.forEach((exp) => {
        if (!expenseCategoryTotals[exp.category]) expenseCategoryTotals[exp.category] = 0;
        expenseCategoryTotals[exp.category] += exp.amount;
      });
      const totalExpenses = Object.values(expenseCategoryTotals).reduce((sum, amount) => sum + amount, 0);

      const withdrawalTotals = {};
      withdrawals.forEach((wd) => {
        const month = wd.date.slice(0, 7);
        const key = wd.workerName + '|' + month;
        if (!withdrawalTotals[key]) withdrawalTotals[key] = 0;
        withdrawalTotals[key] += wd.amount;
      });
      const totalWithdrawals = Object.values(withdrawalTotals).reduce((sum, amount) => sum + amount, 0);

      const invoiceStats = printedInvoices.reduce(
        (acc, invoice) => {
          const total = parseFloat(invoice.total);
          acc.totalInvoices += 1;
          acc.totalAmount += total;
          if (invoice.paymentMethod === 'cash') {
            acc.cashAmount += total;
          } else if (invoice.paymentMethod === 'visa') {
            acc.visaAmount += total;
          }
          return acc;
        },
        { totalInvoices: 0, totalAmount: 0, cashAmount: 0, visaAmount: 0 }
      );

      const invoiceWorkerTotals = printedInvoices.reduce((acc, invoice) => {
        const workerName = invoice.worker || 'غير محدد';
        acc[workerName] = (acc[workerName] || 0) + parseFloat(invoice.total);
        return acc;
      }, {});

      // Monthly income data for current month
      const currentDate = new Date();
      const currentMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
      const monthlyInvoices = printedInvoices.filter(invoice => {
        const invoiceDate = new Date(invoice.date);
        const invoiceMonth = invoiceDate.getFullYear() + '-' + String(invoiceDate.getMonth() + 1).padStart(2, '0');
        return invoiceMonth === currentMonth;
      });

      let monthlyTotalSales = 0;
      let monthlyCashSales = 0;
      let monthlyVisaSales = 0;
      const monthlyWorkerSales = {};

      monthlyInvoices.forEach(invoice => {
        const total = parseFloat(invoice.total);
        monthlyTotalSales += total;

        if (invoice.paymentMethod === 'cash') {
          monthlyCashSales += total;
        } else if (invoice.paymentMethod === 'visa') {
          monthlyVisaSales += total;
        }

        const workerName = invoice.worker || 'غير محدد';
        if (!monthlyWorkerSales[workerName]) {
          monthlyWorkerSales[workerName] = 0;
        }
        monthlyWorkerSales[workerName] += total;
      });

      // Payroll calculations totals for print
      const payrollRows = payrollRecords.map((record) => {
        return `
          <tr>
            <td style="border: 1px solid #000; padding: 8px;">${record.workerName}</td>
            <td style="border: 1px solid #000; padding: 8px;">${record.baseSalary.toFixed(2)}</td>
            <td style="border: 1px solid #000; padding: 8px;">${record.percentage.toFixed(2)}</td>
            <td style="border: 1px solid #000; padding: 8px;">${record.additionalAmount.toFixed(2)}</td>
            <td style="border: 1px solid #000; padding: 8px;">${record.monthlyWithdrawals.toFixed(2)}</td>
            <td style="border: 1px solid #000; padding: 8px;">${record.netSalary.toFixed(2)}</td>
            <td style="border: 1px solid #000; padding: 8px;">${record.month}</td>
            <td style="border: 1px solid #000; padding: 8px;">${new Date(record.calculatedDate).toLocaleDateString('ar-EG')}</td>
          </tr>
        `;
      }).join('');

      const printContent = `
        <div class="printable-content" style="font-family: 'Cairo', Arial, sans-serif; direction: rtl; max-width: 800px; margin: 0 auto;">
          <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="font-size: 24px; font-weight: bold;">مركز الفارس للعناية بالرجل</h1>
            <h2 style="font-size: 20px; margin-top: 10px;">تقرير شامل</h2>
            <p style="margin-top: 10px;">التاريخ: ${new Date().toLocaleDateString('ar-EG')}</p>
          </div>

          <div style="margin-bottom: 30px;">
            <h3 style="font-size: 18px; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 5px;">تقرير الدخل الشهري (${currentMonth})</h3>
            <p style="margin: 10px 0;">إجمالي المبيعات الشهرية: ${monthlyTotalSales.toFixed(2)} ريال</p>
            <p style="margin: 10px 0;">مبيعات كاش: ${monthlyCashSales.toFixed(2)} ريال</p>
            <p style="margin: 10px 0;">مبيعات فيزا: ${monthlyVisaSales.toFixed(2)} ريال</p>
            <p style="margin: 10px 0;">عدد الفواتير: ${monthlyInvoices.length}</p>

            <h4 style="font-size: 16px; font-weight: bold; margin-top: 20px;">مبيعات حسب العامل (الشهر الحالي):</h4>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f0f0f0;">
                  <th style="border: 1px solid #000; padding: 8px;">اسم العامل</th>
                  <th style="border: 1px solid #000; padding: 8px;">إجمالي المبيعات (ريال)</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(monthlyWorkerSales)
                  .map(
                    ([workerName, amount]) => `
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">${workerName}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${amount.toFixed(2)}</td>
                  </tr>`
                  )
                  .join('')}
              </tbody>
            </table>
          </div>

          <div style="margin-bottom: 30px;">
            <h3 style="font-size: 18px; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 5px;">تقرير المصروفات</h3>
            <p style="margin: 10px 0;">إجمالي المصروفات: ${totalExpenses.toFixed(2)} ريال</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f0f0f0;">
                  <th style="border: 1px solid #000; padding: 8px;">الفئة</th>
                  <th style="border: 1px solid #000; padding: 8px;">المبلغ (ريال)</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(expenseCategoryTotals)
                  .map(
                    ([category, amount]) => `
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">${category}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${amount.toFixed(2)}</td>
                  </tr>`
                  )
                  .join('')}
              </tbody>
            </table>
          </div>

          <div style="margin-bottom: 30px;">
            <h3 style="font-size: 18px; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 5px;">تقرير حساب الراتب</h3>
            <p style="margin: 10px 0;">عرض سجلات حساب الرواتب المحسوبة باستخدام المعادلة المتقدمة</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f0f0f0;">
                  <th style="border: 1px solid #000; padding: 8px;">اسم الموظف</th>
                  <th style="border: 1px solid #000; padding: 8px;">الراتب الأساسي</th>
                  <th style="border: 1px solid #000; padding: 8px;">النسبة %</th>
                  <th style="border: 1px solid #000; padding: 8px;">المبلغ الإضافي</th>
                  <th style="border: 1px solid #000; padding: 8px;">السحب الشهري</th>
                  <th style="border: 1px solid #000; padding: 8px;">صافي الراتب</th>
                  <th style="border: 1px solid #000; padding: 8px;">الشهر</th>
                  <th style="border: 1px solid #000; padding: 8px;">تاريخ الحساب</th>
                </tr>
              </thead>
              <tbody>
                ${payrollRows}
              </tbody>
            </table>
          </div>

          <div style="margin-bottom: 30px;">
            <h3 style="font-size: 18px; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 5px;">تقرير السحب</h3>
            <p style="margin: 10px 0;">إجمالي السحب: ${totalWithdrawals.toFixed(2)} ريال</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f0f0f0;">
                  <th style="border: 1px solid #000; padding: 8px;">اسم العامل</th>
                  <th style="border: 1px solid #000; padding: 8px;">الشهر</th>
                  <th style="border: 1px solid #000; padding: 8px;">المبلغ (ريال)</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(withdrawalTotals)
                  .map(([key, amount]) => {
                    const [workerName, month] = key.split('|');
                    return `
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">${workerName}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${month}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${amount.toFixed(2)}</td>
                  </tr>`;
                  })
                  .join('')}
              </tbody>
            </table>
          </div>

          <div style="margin-bottom: 30px;">
            <h3 style="font-size: 18px; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 5px;">تقرير الفواتير (إجمالي)</h3>
            <p style="margin: 10px 0;">عدد الفواتير: ${invoiceStats.totalInvoices}</p>
            <p style="margin: 10px 0;">إجمالي مبيعات الفواتير: ${invoiceStats.totalAmount.toFixed(2)} ريال</p>
            <p style="margin: 10px 0;">المبالغ المدفوعة كاش: ${invoiceStats.cashAmount.toFixed(2)} ريال</p>
            <p style="margin: 10px 0;">المبالغ المدفوعة فيزا: ${invoiceStats.visaAmount.toFixed(2)} ريال</p>

            <h4 style="font-size: 16px; font-weight: bold; margin-top: 20px;">مبيعات حسب العامل (إجمالي):</h4>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f0f0f0;">
                  <th style="border: 1px solid #000; padding: 8px;">اسم العامل</th>
                  <th style="border: 1px solid #000; padding: 8px;">إجمالي المبيعات (ريال)</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(invoiceWorkerTotals)
                  .map(
                    ([workerName, amount]) => `
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">${workerName}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${amount.toFixed(2)}</td>
                  </tr>`
                  )
                  .join('')}
              </tbody>
            </table>
          </div>

          <div style="margin-top: 30px; border-top: 2px solid #000; padding-top: 10px; text-align: center;">
            <p style="font-size: 14px; color: #666;">© 2025 جميع الحقوق محفوظة | تصميم وتطوير بواسطة Eng-A7med-ra مع دعم واتساب</p>
          </div>
        </div>
      `;

      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(`
          <html dir="rtl" lang="ar">
            <head>
              <title>تقرير شامل - مركز الفارس</title>
              <style>
                body { font-family: 'Cairo', Arial, sans-serif; direction: rtl; margin: 0; padding: 20px; }
                .printable-content { max-width: 800px; margin: 0 auto; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #000; padding: 8px; text-align: right; }
                thead tr { background-color: #f0f0f0; }
                @media print {
                  body { margin: 0; padding: 10px; }
                  .printable-content { max-width: none; }
                }
              </style>
            </head>
            <body>${printContent}</body>
          </html>
 `);
        printWindow.document.close();
        printWindow.print();
      }
    }

    function initializeReports() {
      document.getElementById('printAllReportsBtn').addEventListener('click', printAllReports);
    }

    // Daily Salary Functions - MODIFIED FOR MANUAL INPUT
    function calculateAndDisplayDailySalary(workerName, date) {
      const filteredInvoices = printedInvoices.filter(inv => {
        if (!inv.worker) return false;
        if (inv.worker !== workerName) return false;
        
        const invDateObj = new Date(inv.date);
        const invDateStr = invDateObj.getFullYear() + '-' + 
                          String(invDateObj.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(invDateObj.getDate()).padStart(2, '0');
        return invDateStr === date;
      });

      let totalServicesSalary = 0;
      filteredInvoices.forEach(inv => {
        totalServicesSalary += parseFloat(inv.total);
      });

      const totalWithdrawals = withdrawals.reduce((sum, wd) => {
        if (wd.workerName === workerName && wd.date === date) {
          return sum + parseFloat(wd.amount);
        }
        return sum;
      }, 0);

      const netSalary = totalServicesSalary - totalWithdrawals;

      document.getElementById('dailySalaryText').textContent = 
        `العامل: ${workerName}\n` +
        `التاريخ: ${date}\n` +
        `إجمالي رواتب الخدمات: ${totalServicesSalary.toFixed(2)} ريال\n` +
        `إجمالي السحب: ${totalWithdrawals.toFixed(2)} ريال\n` +
        `صافي الراتب: ${netSalary.toFixed(2)} ريال`;

      document.getElementById('dailySalaryResult').classList.remove('hidden');
    }

    function autoDisplayDailySalary() {
      if (printedInvoices.length === 0) {
        document.getElementById('dailySalaryText').textContent = 'لا توجد فواتير مسجلة لعرض الراتب اليومي.';
        document.getElementById('dailySalaryResult').classList.remove('hidden');
        document.getElementById('dailyWorkerSelect').value = "";
        document.getElementById('dailyDateInput').value = "";
        return;
      }

      let firstInvoice = null;
      for (let inv of printedInvoices) {
        if (inv.worker && inv.date) {
          firstInvoice = inv;
          break;
        }
      }

      if (!firstInvoice) {
        document.getElementById('dailySalaryText').textContent = 'لا توجد فواتير صالحة لعرض الراتب اليومي.';
        document.getElementById('dailySalaryResult').classList.remove('hidden');
        document.getElementById('dailyWorkerSelect').value = "";
        document.getElementById('dailyDateInput').value = "";
        return;
      }

      const invDateObj = new Date(firstInvoice.date);
      const invDateStr = invDateObj.getFullYear() + '-' + 
                        String(invDateObj.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(invDateObj.getDate()).padStart(2, '0');

      document.getElementById('dailyWorkerSelect').value = firstInvoice.worker;
      document.getElementById('dailyDateInput').value = invDateStr;

      calculateAndDisplayDailySalary(firstInvoice.worker, invDateStr);
    }

    function initializeDailySalary() {
      const dailySalaryForm = document.getElementById('dailySalaryForm');
      dailySalaryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const workerName = document.getElementById('dailyWorkerSelect').value.trim();
        const date = document.getElementById('dailyDateInput').value;

        if (!workerName || !date) {
          alert('يرجى ملء جميع الحقول بشكل صحيح.');
          return;
        }

        calculateAndDisplayDailySalary(workerName, date);
      });

      document.getElementById('deleteAllDailySalaryBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع بيانات الراتب اليومي؟ (سيتم مسح الفواتير المخزنة)')) {
          localStorage.removeItem('salon_printed_invoices');
          printedInvoices = [];
          document.getElementById('dailySalaryText').textContent = 'تم مسح بيانات الراتب اليومي.';
          document.getElementById('dailySalaryResult').classList.remove('hidden');
        }
      });
    }

    // Monthly Salary Functions - MODIFIED FOR MANUAL INPUT
    function initializeMonthlySalary() {
      const monthlySalaryForm = document.getElementById('monthlySalaryForm');
      monthlySalaryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const workerName = document.getElementById('monthlyWorkerSelect').value.trim();
        const year = document.getElementById('monthlyYearInput').value;
        const month = document.getElementById('monthlyMonthInput').value;

        if (!workerName || !year || !month) {
          alert('يرجى ملء جميع الحقول بشكل صحيح.');
          return;
        }

        const filteredInvoices = printedInvoices.filter(inv => {
          if (!inv.worker) return false;
          if (inv.worker !== workerName) return false;
          const invDate = new Date(inv.date);
          return invDate.getFullYear() === parseInt(year) && (invDate.getMonth() + 1) === parseInt(month);
        });

        let totalServicesSalary = 0;
        filteredInvoices.forEach(inv => {
          totalServicesSalary += parseFloat(inv.total);
        });

        const totalWithdrawals = withdrawals.reduce((sum, wd) => {
          if (wd.workerName === workerName && wd.date.startsWith(`${year}-${month}`)) {
            return sum + parseFloat(wd.amount);
          }
          return sum;
        }, 0);

        const netSalary = totalServicesSalary - totalWithdrawals;

        document.getElementById('monthlySalaryText').textContent = 
          `العامل: ${workerName}\n` +
          `الشهر: ${year}-${month}\n` +
          `إجمالي رواتب الخدمات: ${totalServicesSalary.toFixed(2)} ريال\n` +
          `إجمالي السحب: ${totalWithdrawals.toFixed(2)} ريال\n` +
          `صافي الراتب: ${netSalary.toFixed(2)} ريال`;

        document.getElementById('monthlySalaryResult').classList.remove('hidden');
      });

      document.getElementById('deleteAllMonthlySalaryBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع بيانات الراتب الشهري؟ (سيتم مسح الفواتير المخزنة)')) {
          localStorage.removeItem('salon_printed_invoices');
          printedInvoices = [];
          document.getElementById('monthlySalaryText').textContent = 'تم مسح بيانات الراتب الشهري.';
          document.getElementById('monthlySalaryResult').classList.remove('hidden');
        }
      });
    }

    // Payment Summary Functions
    function updatePaymentSummary() {
      let totalCash = 0;
      let totalVisa = 0;
      
      printedInvoices.forEach(inv => {
        const total = parseFloat(inv.total) || 0;
        if (inv.paymentMethod === 'cash') {
          totalCash += total;
        } else if (inv.paymentMethod === 'visa') {
          totalVisa += total;
        }
      });
      
      document.getElementById('totalCashAmount').textContent = totalCash.toFixed(2) + ' ريال';
      document.getElementById('totalVisaAmount').textContent = totalVisa.toFixed(2) + ' ريال';
      document.getElementById('totalCashAmountTable').textContent = totalCash.toFixed(2);
      document.getElementById('totalVisaAmountTable').textContent = totalVisa.toFixed(2);
    }

    // POS System Functions
    function renderProductGrid() {
      const grid = document.getElementById("productGrid");
      grid.innerHTML = "";
      const productsToShow = showAll ? allProducts : allProducts.slice(0, 6);
      
      productsToShow.forEach((product) => {
        const btn = document.createElement("button");
        btn.className = "bg-white rounded-lg border border-gray-300 p-2 flex flex-col items-center text-xs text-center hover:border-blue-500 hover:shadow-md transition-all duration-200";
        btn.title = product.name;
        btn.onclick = () => addProductToInvoice(product.name, 1, product.price);
        btn.innerHTML = `
          <img alt="${product.alt}" class="mb-2 w-12 h-12 object-cover rounded" src="${product.img}" />
          <span class="text-xs font-medium">${product.name}</span>
          <span class="text-xs text-green-600 font-bold">${product.price} ريال</span>
        `;
        grid.appendChild(btn);
      });
      
      const showMoreBtn = document.getElementById("showMoreBtn");
      showMoreBtn.textContent = showAll ? "عرض أقل" : "عرض المزيد";
    }

    function addProductToInvoice(name, quantity, price) {
      const existingIndex = invoiceItems.findIndex(item => item.name === name);
      if (existingIndex !== -1) {
        invoiceItems[existingIndex].quantity += quantity;
        invoiceItems[existingIndex].price = price;
      } else {
        invoiceItems.push({ name, quantity, price, discount: 0 });
      }
      renderInvoice();
    }

    function renderInvoice() {
      const container = document.getElementById("invoiceItems");
      container.innerHTML = "";
      
      invoiceItems.forEach((item, index) => {
        const totalPrice = (item.price * item.quantity * (1 - item.discount / 100)).toFixed(2);
        const row = document.createElement("div");
        row.className = "grid grid-cols-6 gap-2 items-center text-sm text-gray-800 border-b border-gray-200 py-2";
        row.innerHTML = `
          <div class="text-xs">${item.name}</div>
          <div>
            <input type="number" min="1" value="${item.quantity}" class="w-full border border-gray-300 rounded text-xs text-center p-1" data-index="${index}" data-type="quantity" />
          </div>
          <div>
            <input type="number" min="0" step="0.01" value="${item.price.toFixed(2)}" class="w-full border border-gray-300 rounded text-xs text-center p-1" data-index="${index}" data-type="price" />
          </div>
          <div>
            <input type="number" min="0" max="100" value="${item.discount}" class="w-full border border-gray-300 rounded text-xs text-center p-1" data-index="${index}" data-type="discount" />
          </div>
          <div class="text-xs font-semibold">${totalPrice}</div>
          <div>
            <button class="text-red-500 text-lg font-bold hover:text-red-700 transition" data-index="${index}" data-action="remove">×</button>
          </div>
        `;
        container.appendChild(row);
      });
      
      updateTotal();
      attachInputListeners();
    }

    function attachInputListeners() {
      const container = document.getElementById("invoiceItems");
      
      container.querySelectorAll("input").forEach((input) => {
        input.oninput = (e) => {
          const index = +e.target.getAttribute("data-index");
          const type = e.target.getAttribute("data-type");
          
          if (type === "quantity") {
            let val = parseInt(e.target.value);
            if (isNaN(val) || val < 1) val = 1;
            invoiceItems[index].quantity = val;
          } else if (type === "price") {
            let val = parseFloat(e.target.value);
            if (isNaN(val) || val < 0) val = 0;
            invoiceItems[index].price = val;
          } else if (type === "discount") {
            let val = parseInt(e.target.value);
            if (isNaN(val) || val < 0) val = 0;
            if (val > 100) val = 100;
            invoiceItems[index].discount = val;
          }
          renderInvoice();
        };
      });
      
      container.querySelectorAll("button[data-action='remove']").forEach((btn) => {
        btn.onclick = (e) => {
          if (!confirmPasswordPrompt()) return;
          const index = +e.target.getAttribute("data-index");
          invoiceItems.splice(index, 1);
          renderInvoice();
        };
      });
    }

    function updateTotal() {
      const totalEl = document.getElementById("totalAmount");
      const total = invoiceItems.reduce((sum, item) => {
        return sum + item.price * item.quantity * (1 - item.discount / 100);
      }, 0);
      totalEl.textContent = `المجموع: ${total.toFixed(2)} ريال`;
    }

    function clearInvoice() {
      if (!confirmPasswordPrompt()) return;
      if (confirm("هل أنت متأكد من إلغاء الفاتورة؟")) {
        invoiceItems = [];
        renderInvoice();
        document.getElementById("workerName").value = "";
        document.getElementById("customerName").value = "";
        document.getElementById("paymentMethod").value = "cash";
      }
    }

    function completeSaleAndPrint() {
      if (invoiceItems.length === 0) {
        alert("لا توجد منتجات أو خدمات في الفاتورة.");
        return;
      }
      
      const worker = document.getElementById("workerName").value.trim();
      if (!worker) {
        alert("يرجى كتابة اسم العامل قبل إتمام البيع.");
        document.getElementById("workerName").focus();
        return;
      }
      
      const paymentMethod = document.getElementById("paymentMethod").value;
      const invoiceData = printInvoice(paymentMethod);
      
      // Send WhatsApp message with invoice data
      if (invoiceData) {
        sendWhatsAppMessage(invoiceData);
      }
      
      alert("تم إتمام البيع بنجاح!\nشكراً لاستخدامك نظام مركز الفارس.");
      
      invoiceItems = [];
      renderInvoice();
      document.getElementById("workerName").value = "";
      document.getElementById("customerName").value = "";
      document.getElementById("paymentMethod").value = "cash";
    }

    function printInvoice(paymentMethod) {
      const worker = document.getElementById("workerName").value.trim() || "غير محدد";
      const customer = document.getElementById("customerName").value.trim() || "عميل عابر";
      const receiptDiv = document.getElementById("printableReceipt");
      
      let receiptText = "";
      receiptText += "مركز الفارس للعناية بالرجل\n";
      receiptText += "------------------------------\n";
      const date = new Date();
      receiptText += `التاريخ: ${date.toLocaleDateString("ar-EG")} - الوقت: ${date.toLocaleTimeString("ar-EG")}\n`;
      receiptText += `العامل: ${worker}\n`;
      receiptText += `العميل: ${customer}\n`;
      receiptText += `طريقة الدفع: ${paymentMethod === 'cash' ? 'كاش' : 'فيزا'}\n`;
      receiptText += "------------------------------\n";
      
      invoiceItems.forEach(item => {
        const totalPrice = (item.price * item.quantity * (1 - item.discount / 100)).toFixed(2);
        receiptText += `${item.name} x${item.quantity} - ${item.price.toFixed(2)} ريال\n`;
        if (item.discount > 0) {
          receiptText += `  خصم: ${item.discount}%\n`;
        }
        receiptText += `  الإجمالي: ${totalPrice} ريال\n`;
        receiptText += "------------------------------\n";
      });
      
      const total = invoiceItems.reduce((sum, item) => {
        return sum + item.price * item.quantity * (1 - item.discount / 100);
      }, 0);
      
      receiptText += `المجموع: ${total.toFixed(2)} ريال\n`;
      receiptText += "\nشكراً لزيارتكم مركز الفارس \n";

      receiptDiv.textContent = receiptText;

      // Save printed invoice
      const printedInvoice = {
        id: Date.now(),
        date: date.toISOString(),
        worker,
        customer,
        items: JSON.parse(JSON.stringify(invoiceItems)),
        total: total.toFixed(2),
        paymentMethod
      };
      
      printedInvoices.push(printedInvoice);
      localStorage.setItem("salon_printed_invoices", JSON.stringify(printedInvoices));

      receiptDiv.classList.remove("hidden");
      window.print();
      receiptDiv.classList.add("hidden");

      // Return invoice data for WhatsApp
      return printedInvoice;
    }

    function filterProducts() {
      const filter = document.getElementById("searchInput").value.trim();
      const grid = document.getElementById("productGrid");
      const buttons = grid.querySelectorAll("button");
      
      buttons.forEach((btn) => {
        const text = btn.textContent.trim();
        if (text.includes(filter)) {
          btn.style.display = "flex";
        } else {
          btn.style.display = "none";
        }
      });
    }

    function renderInvoiceLog() {
      const tbody = document.getElementById('invoiceLogTableBody');
      tbody.innerHTML = '';
      
      if (printedInvoices.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 8;
        td.className = 'text-center py-4 text-gray-500';
        td.textContent = 'لا توجد فواتير مسجلة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      
      printedInvoices.forEach((inv, idx) => {
        const tr = document.createElement('tr');
        const dateObj = new Date(inv.date);
        const formattedDate = dateObj.toLocaleDateString('ar-EG') + ' ' + dateObj.toLocaleTimeString('ar-EG');
        tr.innerHTML = `
          <td class="px-3 py-2">${inv.id}</td>
          <td class="px-3 py-2">${formattedDate}</td>
          <td class="px-3 py-2">${inv.worker}</td>
          <td class="px-3 py-2">${inv.customer}</td>
          <td class="px-3 py-2 text-center">${inv.items.length}</td>
          <td class="px-3 py-2 text-center">${parseFloat(inv.total).toFixed(2)}</td>
          <td class="px-3 py-2 text-center">${inv.paymentMethod === 'cash' ? 'كاش' : 'فيزا'}</td>
          <td class="px-3 py-2 text-center">
            <button data-index="${idx}" class="deleteInvoiceBtn text-red-600 hover:text-red-800 focus:outline-none">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.deleteInvoiceBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (!confirmPasswordPrompt()) return;
          const idx = e.currentTarget.getAttribute('data-index');
          if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء.')) {
            printedInvoices.splice(idx, 1);
            localStorage.setItem("salon_printed_invoices", JSON.stringify(printedInvoices));
            renderInvoiceLog();
          }
        });
      });
    }

    function initializePOS() {
      renderInvoice();
      renderProductGrid();
      
      // Search functionality
      document.getElementById("searchInput").addEventListener('input', filterProducts);
      
      // Show more/less button
      document.getElementById("showMoreBtn").addEventListener('click', () => {
        showAll = !showAll;
        renderProductGrid();
      });
      
      // Add product by name
      document.getElementById("addProductByNameBtn").addEventListener('click', () => {
        const input = document.getElementById("addProductInput");
        const priceInput = document.getElementById("manualPriceInput");
        const name = input.value.trim();
        let price = parseFloat(priceInput.value);
        
        if (!name) {
          alert("يرجى إدخال اسم المنتج أو الخدمة.");
          return;
        }
        if (isNaN(price) || price < 0) {
          alert("يرجى إدخال سعر صالح.");
          return;
        }
        
        addProductToInvoice(name, 1, price);
        input.value = "";
        priceInput.value = "";
      });
      
      // Enter key for add product input
      document.getElementById("addProductInput").addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          document.getElementById("addProductByNameBtn").click();
        }
      });
      
      // Clear invoice button
      document.getElementById("clearInvoiceBtn").addEventListener('click', clearInvoice);
      
      // Complete sale button
      document.getElementById("completeSaleBtn").addEventListener('click', completeSaleAndPrint);
      
      // Invoice log buttons
      document.getElementById("showInvoiceLogBtn").addEventListener('click', () => {
        renderInvoiceLog();
        document.getElementById("invoiceLogSection").classList.remove('hidden');
      });
      
      document.getElementById("closeInvoiceLogBtn").addEventListener('click', () => {
        document.getElementById("invoiceLogSection").classList.add('hidden');
      });
      
      document.getElementById('deleteAllInvoicesBtn').addEventListener('click', () => {
        if (!confirmPasswordPrompt()) return;
        if (confirm('هل أنت متأكد من مسح جميع الفواتير؟ لا يمكن التراجع عن هذا الإجراء.')) {
          printedInvoices = [];
          localStorage.removeItem('salon_printed_invoices');
          renderInvoiceLog();
        }
      });
      
      document.getElementById('backFromPOSBtn').addEventListener('click', () => {
        document.getElementById('posSection').classList.add('hidden');
        document.getElementById('home').classList.remove('hidden');
      });
    }

    // Initialize Application
    function initializeApp() {
      // Initialize authentication
      initializeAuth();
      
      // Initialize navigation
      initializeNavigation();
      
      // Initialize all modules
      initializeExpenses();
      initializePayrollManagement();
      initializeWithdrawals();
      initializeEnhancedAppointments();
      initializeServices();
      initializeInventory();
      initializeReports();
      initializeDailySalary();
      initializeMonthlySalary();
      initializePOS();
       
      // Show login page initially
      showLogin();
    }

    // Start the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
